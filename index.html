<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>איפוס סיסמה - מערכת הסעות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #507480;
            --color-accent: #FFCA0F;
            --color-success: #10b981;
            --color-error: #ef4444;
            --color-text-dark: #374151;
            --color-bg-light: #e5e7eb;
            --color-modal-backdrop: rgba(80, 116, 128, 0.7);
        }
        
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
        }
        .modal-backdrop {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        // Color Palette
        const COLORS = {
            primary: '#507480',
            accent: '#FFCA0F',
            success: '#10b981',
            error: '#ef4444',
            textDark: '#374151',
            bgLight: '#e5e7eb',
            modalBackdrop: 'rgba(80, 116, 128, 0.7)'
        };

        // State
        let employees = [];
        let resetState = {
            employee: null,
            token: null,
            show: false
        };

        // Load employees from localStorage
        function loadEmployees() {
            const stored = localStorage.getItem('employees');
            if (stored) {
                employees = JSON.parse(stored);
            }
        }

        // Check for password reset token in URL
        function checkPasswordResetToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('reset');
            
            console.log('Checking reset token:', resetToken);
            console.log('Employees loaded:', employees.length);
            
            if (!resetToken) {
                renderError('קישור לא תקין. אנא השתמש בקישור מהאימייל.');
                return;
            }

            // Load reset tokens from localStorage (might be empty if coming from different domain)
            const resetTokens = JSON.parse(localStorage.getItem('passwordResetTokens') || '{}');
            const tokenData = resetTokens[resetToken];
            
            console.log('Token data from localStorage:', tokenData);
            
            if (!tokenData) {
                // Try to verify by email hash (for cross-domain support)
                if (resetToken.includes('_')) {
                    const [token, emailHash] = resetToken.split('_');
                    console.log('Token parts:', { token, emailHash });
                    
                    // Find employee by matching email hash
                    for (const emp of employees) {
                        if (emp.email) {
                            const empEmail = emp.email.toLowerCase().trim();
                            const empEmailHash = btoa(empEmail).substring(0, 10);
                            console.log('Comparing:', {
                                employee: emp.name,
                                email: empEmail,
                                hash: empEmailHash,
                                tokenHash: emailHash,
                                match: empEmailHash === emailHash
                            });
                            
                            if (empEmailHash === emailHash) {
                                console.log('Found matching employee:', emp.name);
                                resetState.employee = emp;
                                resetState.token = resetToken;
                                resetState.show = true;
                                
                                // Remove token from URL
                                window.history.replaceState({}, document.title, window.location.pathname);
                                render();
                                return;
                            }
                        }
                    }
                    
                    console.log('No matching employee found for email hash');
                } else {
                    console.log('Token does not contain email hash');
                }
                
                renderError('קישור איפוס הסיסמה לא תקין או פג תוקף. אנא בקש קישור חדש.');
                return;
            }

            // Check if token is expired (1 hour)
            const now = Date.now();
            if (now - tokenData.timestamp > tokenData.expiresIn) {
                renderError('קישור איפוס הסיסמה פג תוקף. אנא בקש קישור חדש.');
                // Clean up expired token
                delete resetTokens[resetToken];
                localStorage.setItem('passwordResetTokens', JSON.stringify(resetTokens));
                return;
            }
            
            // Find the employee
            const employee = employees.find(e => 
                e.id === tokenData.employeeId || 
                (tokenData.email && e.email && e.email.toLowerCase() === tokenData.email)
            );
            
            if (employee) {
                resetState.employee = employee;
                resetState.token = resetToken;
                resetState.show = true;
                
                // Clean up used token
                delete resetTokens[resetToken];
                localStorage.setItem('passwordResetTokens', JSON.stringify(resetTokens));
                
                // Remove token from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                render();
            } else {
                renderError('עובד לא נמצא. אנא בקש קישור חדש.');
            }
        }

        // Reset password
        function resetPassword() {
            const newPassword = document.getElementById('newPassword')?.value;
            const confirmNewPassword = document.getElementById('confirmNewPassword')?.value;

            if (!newPassword || !confirmNewPassword) {
                alert('אנא מלא את כל השדות');
                return;
            }

            if (newPassword.length < 4) {
                alert('הסיסמה חייבת להכיל לפחות 4 תווים');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                alert('הסיסמאות אינן תואמות');
                return;
            }

            if (resetState.employee) {
                const empIndex = employees.findIndex(e => e.id === resetState.employee.id);
                if (empIndex !== -1) {
                    employees[empIndex].password = newPassword;
                    localStorage.setItem('employees', JSON.stringify(employees));
                    renderSuccess();
                } else {
                    alert('שגיאה: עובד לא נמצא');
                }
            }
        }

        // Render functions
        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8 text-center">
                        <i class="fas fa-exclamation-triangle text-5xl mb-4" style="color: ${COLORS.error};"></i>
                        <h2 class="text-xl font-bold text-gray-800 mb-4">שגיאה</h2>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <a href="transport-system.html" class="inline-block px-6 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.primary}; color: white;">
                            חזור למערכת
                        </a>
                    </div>
                </div>
            `;
        }

        function renderSuccess() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8 text-center">
                        <i class="fas fa-check-circle text-5xl mb-4" style="color: ${COLORS.success};"></i>
                        <h2 class="text-xl font-bold text-gray-800 mb-4">הסיסמה עודכנה בהצלחה!</h2>
                        <p class="text-gray-600 mb-6">כעת תוכל להתחבר עם הסיסמה החדשה</p>
                        <a href="transport-system.html" class="inline-block px-6 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                            התחבר למערכת
                        </a>
                    </div>
                </div>
            `;
        }

        function render() {
            if (!resetState.show || !resetState.employee) {
                return;
            }

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
                        <div class="p-6 lg:p-8">
                            <div class="text-center mb-6">
                                <i class="fas fa-lock text-5xl mb-4" style="color: ${COLORS.accent};"></i>
                                <h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">הגדר סיסמה חדשה</h3>
                                <p class="text-gray-600 text-sm">עבור: ${resetState.employee.name || ''}</p>
                            </div>

                            <form onsubmit="event.preventDefault(); resetPassword();" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">סיסמה חדשה *</label>
                                    <input type="password" id="newPassword" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">אישור סיסמה *</label>
                                    <input type="password" id="confirmNewPassword" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                </div>
                                
                                <button type="submit" class="w-full py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                    שמור סיסמה
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        loadEmployees();
        console.log('Loaded employees:', employees.length);
        if (employees.length === 0) {
            console.warn('No employees found in localStorage. Make sure employees are stored.');
        }
        checkPasswordResetToken();
    </script>
</body>
</html>
