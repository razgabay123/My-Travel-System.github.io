<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Travel System</title>
    <meta name="theme-color" content="#507480">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Travel System">
    <link rel="apple-touch-icon" href="icons/icon-192.png?v=3">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-192.png?v=3">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png?v=3">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-192.png?v=3">

    <!-- Standard Icons -->
    <link rel="icon" type="image/svg+xml" href="car.svg?v=2">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png?v=3">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png?v=3">
    <link rel="manifest" href="manifest.json?v=4">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for report charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Leaflet.js - Free OpenStreetMap integration, no API key needed -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- EmailJS - Free email service (200 emails/month free) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>

        :root {
            --color-primary: #507480;        /* Main grey */
            --color-accent: #FFCA0F;         /* Yellow */
            --color-success: #10b981;        /* Green */
            --color-error: #ef4444;          /* Red */
            --color-text-dark: #374151;      /* Dark grey text */
            --color-bg-light: #e5e7eb;       /* Light grey bg */
            --color-modal-backdrop: rgba(80, 116, 128, 0.7);
        }
        
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
        }

        html, body {
            overflow-x: visible;
            overflow-y: auto;
        }

        .modal-backdrop {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        /* Leaflet map container styling */
        #route-map-container {
            z-index: 1;
        }
        .leaflet-container {
            font-family: inherit;
        }

        /* Yellow Ribbon Button - Folded Banner Style */
        #downloadAppRibbon {
            position: fixed;
            top: 16px;
            left: 50%;
            z-index: 40;
            cursor: pointer;
            transform: translateX(-50%);
            transform-origin: center;
            width: auto;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: bold;
            font-size: 16px;
            color: #507480;
            transition: all 0.3s ease;
            padding: 10px 16px;
            /* Main ribbon body */
            background: linear-gradient(135deg, #FFCA0F 0%, #FFD700 50%, #FFCA0F 100%);
            box-shadow: 
                0 4px 8px rgba(80, 116, 128, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(80, 116, 128, 0.2);
            border-radius: 999px;
            white-space: nowrap;
            box-sizing: border-box;
        }

        html.login-screen,
        body.login-screen {
            overflow: hidden;
        }

        body.login-screen #app {
            height: 100vh;
            overflow: hidden;
        }

        #downloadAppRibbon::before {
            display: none;
        }

        #downloadAppRibbon::after {
            display: none;
        }

        #downloadAppRibbon:hover {
            transform: translateX(-50%) scale(1.03);
            box-shadow: 
                0 6px 12px rgba(80, 116, 128, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(80, 116, 128, 0.3);
        }

        #downloadAppRibbon i {
            font-size: 21px;
            flex-shrink: 0;
        }

        #downloadAppRibbon span {
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            letter-spacing: 0.8px;
            flex-shrink: 0;
        }

        @media (max-width: 1024px) {
            #downloadAppRibbon {
                font-size: 17px;
                left: 50%;
                padding: 10px 16px;
            }
            
            #downloadAppRibbon i {
                font-size: 19px;
            }
        }

        @media (max-width: 768px) {
            #downloadAppRibbon {
                font-size: 16px;
                left: 50%;
                padding: 10px 16px;
            }
            
            #downloadAppRibbon i {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            #downloadAppRibbon {
                font-size: 14px;
                left: 50%;
                padding: 9px 14px;
            }
            
            #downloadAppRibbon i {
                font-size: 16px;
            }
        }

        @media (max-width: 640px) {
            #downloadAppRibbon {
                transform: translateX(-50%);
                top: 12px;
                left: 50%;
                padding: 9px 14px;
            }

            #downloadAppRibbon::before,
            #downloadAppRibbon::after {
                display: none;
            }

            #downloadAppRibbon:hover {
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Yellow Ribbon Download Button -->
    <div id="downloadAppRibbon" onclick="handleDownloadAPK(event)" title="הורדת האפליקציה">
        <i class="fas fa-car"></i>
        <span>להורדת האפליקציה</span>
    </div>
    
    <div id="app"></div>

    <script>

        // Color Palette - Centralized color definitions
        const COLORS = {
            primary: '#507480',
            accent: '#FFCA0F',
            success: '#10b981',
            error: '#ef4444',
            textDark: '#374151',
            bgLight: '#e5e7eb',
            modalBackdrop: 'rgba(80, 116, 128, 0.7)'
        };

        // Email Configuration
        // Using EmailJS (https://www.emailjs.com) - Free tier: 200 emails/month
        // 
        // SETUP INSTRUCTIONS (5 minutes):
        // 1. Go to https://www.emailjs.com and create a free account
        // 2. Create an email service (Gmail, Outlook, etc.)
        // 3. Create an email template with variables: {{to_email}}, {{reset_link}}, {{user_name}}
        // 4. Copy your Public Key, Service ID, and Template ID
        // 5. Update EMAIL_CONFIG below with your credentials
        //
        const EMAIL_CONFIG = {
            enabled: true, // Set to true after EmailJS setup
            serviceId: 'service_hizfexe', // From EmailJS dashboard
            templateId: 'template_g0fjesl', // From EmailJS dashboard
            publicKey: 'wqjXHpEuuQHKdV0PB', // From EmailJS dashboard
            baseUrl: 'https://razgabay123.github.io' // GitHub Pages URL
        };

        // Backend API Configuration
        const API_CONFIG = {
            baseUrl: 'https://my-travel-system.onrender.com/api'
        };

        // נתונים - Load from backend API
        let employees = [];
        let drivers = [];

        // Load workers data from backend API
        async function loadWorkersData() {
            try {
                // Fetch employees
                const empResponse = await fetch(`${API_CONFIG.baseUrl}/employees`);
                if (!empResponse.ok) throw new Error('Failed to fetch employees');
                const empData = await empResponse.json();
                employees = empData.employees || [];

                // Fetch drivers
                const driverResponse = await fetch(`${API_CONFIG.baseUrl}/drivers`);
                if (!driverResponse.ok) throw new Error('Failed to fetch drivers');
                const driverData = await driverResponse.json();
                drivers = driverData.drivers || [];

                console.log('Workers data loaded from API:', employees.length, 'employees,', drivers.length, 'drivers');
                return true;
            } catch (error) {
                console.error('Error loading workers data from API:', error);
                alert('שגיאה בטעינת נתוני עובדים. ודא שהשרת פועל (npm start בתיקיית backend).');
                return false;
            }
        }

        // Load from localStorage if available (for offline support)
        function loadFromLocalStorage() {
            const storedEmployees = localStorage.getItem('employees');
            const storedDrivers = localStorage.getItem('drivers');
            if (storedEmployees) employees = JSON.parse(storedEmployees);
            if (storedDrivers) drivers = JSON.parse(storedDrivers);
        }

        let currentSection = 'login';

        let sidebarOpen = window.innerWidth >= 1024; // Open on desktop, closed on mobile
        let modalState = { show: false, type: '', message: '', onConfirm: null, workerId: null, workerName: null, editEmployee: null, driverName: null };
        let selectedCancellationDates = new Set(); // For multi-date selection
        let loggedInUserId = null; // Track logged-in user
        let routeModalState = { show: false, routeName: '', selectedLocations: [], map: null, autocomplete: null, markers: [] };
        let isGeocoding = false; // Prevent multiple simultaneous geocoding requests
        let registerModalState = { show: false };
        let forgotPasswordModalState = { show: false, step: 'verify', verifiedEmployee: null }; // step: 'verify' or 'reset'
        let alertsModalState = { show: false };
        let addEmployeeModalState = { show: false };

        // Load alerts from localStorage and auto-cleanup old ones
        function getAlerts() {
            const stored = localStorage.getItem('alerts');
            if (stored) {
                const alerts = JSON.parse(stored);
                const today = new Date();
                // Filter out alerts older than 4 days
                const filteredAlerts = alerts.filter(alert => {
                    const alertDate = new Date(alert.date);
                    const daysDiff = Math.floor((today - alertDate) / (1000 * 60 * 60 * 24));
                    return daysDiff < 4;
                });
                // Save filtered alerts back if any were removed
                if (filteredAlerts.length !== alerts.length) {
                    saveAlerts(filteredAlerts);
                }
                return filteredAlerts;
            }
            return [];
        }

        // Save alerts to localStorage
        function saveAlerts(alerts) {
            localStorage.setItem('alerts', JSON.stringify(alerts));
        }

        // Add new alert
        function addAlert(text) {
            const alerts = getAlerts();
            alerts.push({
                id: Date.now(),
                text: text,
                date: new Date().toISOString()
            });
            saveAlerts(alerts);
        }

        // Delete alert
        function deleteAlert(alertId) {
            const alerts = getAlerts();
            const filteredAlerts = alerts.filter(alert => alert.id !== alertId);
            saveAlerts(filteredAlerts);
            render();
        }

        // Get today's absent workers
        function getAbsentWorkersToday() {
            const today = getTodayDateString();
            const absentWorkers = [];
            
            employees.forEach(emp => {
                if (isWorkerRemoved(emp.id) || isWorkerScheduledAbsent(emp.id, today)) {
                    absentWorkers.push(emp.name);
                }
            });
            
            return absentWorkers;
        }

        // Load employees from localStorage on page load
        function loadEmployees() {
            const stored = localStorage.getItem('employees');
            if (stored) {
                const storedEmployees = JSON.parse(stored);
                // Replace the entire employees array with stored employees
                // This ensures imported employees are loaded
                if (storedEmployees.length > 0) {
                    employees.length = 0; // Clear existing
                    employees.push(...storedEmployees); // Add all stored employees
                }
            }
        }

        // Save employees to localStorage
        function saveEmployees() {
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('drivers', JSON.stringify(drivers));
        }

        // Note: Initialization moved to initApp() function at the bottom

        // פונקציות לניהול הסרה עצמית (same-day removal)
        function getRemovedWorkers() {
            const stored = localStorage.getItem('removedWorkers');
            return stored ? JSON.parse(stored) : {};
        }

        function saveRemovedWorkers(removedWorkers) {
            localStorage.setItem('removedWorkers', JSON.stringify(removedWorkers));
        }

        // פונקציות לניהול סטטוס נסיעה יומי (daily transportation status from סידור עובדים)
        function getDailyTransportationStatus() {
            const today = getTodayDateString();
            const stored = localStorage.getItem('dailyTransportationStatus');
            const allStatuses = stored ? JSON.parse(stored) : {};
            return allStatuses[today] || null; // Returns null if not set for today
        }

        function saveDailyTransportationStatus(status) {
            const today = getTodayDateString();
            const stored = localStorage.getItem('dailyTransportationStatus');
            const allStatuses = stored ? JSON.parse(stored) : {};
            allStatuses[today] = status; // Format: { employeeId: true/false }
            localStorage.setItem('dailyTransportationStatus', JSON.stringify(allStatuses));
        }

        function setEmployeeTransportationStatus(employeeId, isComing) {
            const today = getTodayDateString();
            const stored = localStorage.getItem('dailyTransportationStatus');
            const allStatuses = stored ? JSON.parse(stored) : {};
            if (!allStatuses[today]) {
                allStatuses[today] = {};
            }
            allStatuses[today][employeeId.toString()] = isComing;
            localStorage.setItem('dailyTransportationStatus', JSON.stringify(allStatuses));
        }

        function isEmployeeComingToday(employeeId) {
            const todayStatus = getDailyTransportationStatus();
            if (!todayStatus) return null; // Not set yet
            return todayStatus[employeeId.toString()] === true;
        }

        // פונקציות לניהול ביטולי נסיעות מתוזמנים (scheduled cancellations)
        function getScheduledCancellations() {
            const stored = localStorage.getItem('scheduledCancellations');
            return stored ? JSON.parse(stored) : {}; // Format: { workerId: [date1, date2, ...] }
        }

        function saveScheduledCancellations(cancellations) {
            localStorage.setItem('scheduledCancellations', JSON.stringify(cancellations));
        }

        function addScheduledCancellation(workerId, dates) {
            const cancellations = getScheduledCancellations();
            const workerIdStr = workerId.toString();
            if (!cancellations[workerIdStr]) {
                cancellations[workerIdStr] = [];
            }
            // Add dates that aren't already there
            dates.forEach(date => {
                if (!cancellations[workerIdStr].includes(date)) {
                    cancellations[workerIdStr].push(date);
                }
            });
            cancellations[workerIdStr].sort(); // Keep dates sorted
            saveScheduledCancellations(cancellations);
        }

        function removeScheduledCancellation(workerId, date) {
            const cancellations = getScheduledCancellations();
            const workerIdStr = workerId.toString();
            if (cancellations[workerIdStr]) {
                cancellations[workerIdStr] = cancellations[workerIdStr].filter(d => d !== date);
                if (cancellations[workerIdStr].length === 0) {
                    delete cancellations[workerIdStr];
                }
                saveScheduledCancellations(cancellations);
            }
        }

        function isWorkerScheduledAbsent(workerId, date) {
            const cancellations = getScheduledCancellations();
            const workerIdStr = workerId.toString();
            return cancellations[workerIdStr] && cancellations[workerIdStr].includes(date);
        }

        function getTodayDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function checkAndRestoreWorkers() {
            const removedWorkers = getRemovedWorkers();
            const today = getTodayDateString();
            let updated = false;

            // Check each removed worker - if removed on a different day, restore them
            for (const workerId in removedWorkers) {
                const removalData = removedWorkers[workerId];
                let removalDate;
                
                // Handle both old format (timestamp) and new format (date string)
                if (typeof removalData === 'number') {
                    // Old format: convert timestamp to date string
                    const removalDateObj = new Date(removalData);
                    const year = removalDateObj.getFullYear();
                    const month = String(removalDateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(removalDateObj.getDate()).padStart(2, '0');
                    removalDate = `${year}-${month}-${day}`;
                } else {
                    // New format: already a date string
                    removalDate = removalData;
                }

                // If removed on a different day, restore them
                if (removalDate !== today) {
                    delete removedWorkers[workerId];
                    updated = true;
                }
            }

            if (updated) {
                saveRemovedWorkers(removedWorkers);
            }

            return updated;
        }

        function removeWorkerForToday(workerId) {
            const removedWorkers = getRemovedWorkers();
            // Store today's date string instead of timestamp
            const today = getTodayDateString();
            removedWorkers[workerId.toString()] = today;
            saveRemovedWorkers(removedWorkers);
            console.log('Worker removed:', workerId, 'Date:', today, 'Removed workers:', removedWorkers);
        }

        function restoreWorker(workerId) {
            const removedWorkers = getRemovedWorkers();
            // Delete both string and number keys
            delete removedWorkers[workerId];
            delete removedWorkers[workerId.toString()];
            saveRemovedWorkers(removedWorkers);
            console.log('Worker restored:', workerId);
            render();
        }


        function isWorkerRemoved(workerId) {
            const removedWorkers = getRemovedWorkers();
            // Check both string and number keys for same-day removal
            const sameDayRemoved = removedWorkers.hasOwnProperty(workerId) || removedWorkers.hasOwnProperty(workerId.toString());
            
            // Also check scheduled cancellations for today
            const today = getTodayDateString();
            const scheduledAbsent = isWorkerScheduledAbsent(workerId, today);
            
            return sameDayRemoved || scheduledAbsent;
        }

        function getActiveEmployees() {
            checkAndRestoreWorkers();
            return employees.filter(emp => !isWorkerRemoved(emp.id));
        }

        function getRemovedEmployees() {
            // Check and restore workers removed on previous days (same-day removals only)
            checkAndRestoreWorkers();
            
            // Get removed workers for today only (includes scheduled cancellations)
            const removedWorkers = getRemovedWorkers();
            const today = getTodayDateString();
            
            // Filter to show workers who are absent today (either same-day removal or scheduled)
            const removed = employees.filter(emp => {
                // Check same-day removal
                const workerIdStr = emp.id.toString();
                const removalData = removedWorkers[workerIdStr] || removedWorkers[emp.id];
                
                let sameDayRemoved = false;
                if (removalData) {
                    let removalDate;
                    if (typeof removalData === 'number') {
                        const removalDateObj = new Date(removalData);
                        const year = removalDateObj.getFullYear();
                        const month = String(removalDateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(removalDateObj.getDate()).padStart(2, '0');
                        removalDate = `${year}-${month}-${day}`;
                    } else {
                        removalDate = removalData;
                    }
                    sameDayRemoved = removalDate === today;
                }
                
                // Check scheduled cancellation for today
                const scheduledAbsent = isWorkerScheduledAbsent(emp.id, today);
                
                return sameDayRemoved || scheduledAbsent;
            });
            
            console.log('getRemovedEmployees - Today:', today, 'Removed employees:', removed.length, removed.map(e => e.name));
            return removed;
        }

        function showModal(type, message, onConfirm, workerId = null, workerName = null) {
            console.log('showModal called:', type, message, workerId, workerName);
            modalState = {
                show: true,
                type: type,
                message: message,
                onConfirm: onConfirm,
                workerId: workerId,
                workerName: workerName
            };
            render();
        }

        function hideModal() {
            modalState = { show: false, type: '', message: '', onConfirm: null, workerId: null, workerName: null };
            render();
        }

        function confirmModalAction() {
            console.log('confirmModalAction called, type:', modalState.type, 'workerId:', modalState.workerId);
            if (modalState.type === 'confirm' && modalState.workerId) {
                // Remove the worker
                removeWorkerForToday(modalState.workerId);
                // Hide confirmation modal
                modalState.show = false;
                // Force render to update the table
                render();
                // Show success modal after a brief delay
                setTimeout(() => {
                    showModal('success', 'מחיקת הנסיעה אושרה', null);
                }, 200);
            } else if (modalState.type === 'confirm-delete-route' && modalState.onConfirm) {
                // Execute the delete route callback
                modalState.onConfirm();
            } else if (modalState.type === 'confirm-delete-employee' && modalState.onConfirm) {
                // Execute the delete employee callback
                modalState.onConfirm();
            } else if (modalState.type === 'success') {
                // Close success modal
                hideModal();
            }
        }

        function handleSelfRemoval(workerId, workerName) {
            console.log('handleSelfRemoval called with:', workerId, workerName);
            showModal('confirm', 'האם אתה בטוח שלא תבוא היום?', null, workerId, workerName);
        }

        function handleEdit(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (employee) {
                modalState = {
                    show: true,
                    type: 'edit',
                    editEmployee: { ...employee } // Create a copy for editing
                };
                render();
            }
        }

        function saveEmployeeEdit() {
            if (!modalState.editEmployee) return;
            
            // Get values from form inputs
            const name = document.getElementById('editName').value.trim();
            const department = document.getElementById('editDepartment').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            const city = document.getElementById('editCity').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const email = document.getElementById('editEmail')?.value.trim() || '';
            const route = document.getElementById('editRoute').value;
            const time = document.getElementById('editTime').value;
            
            if (!name || !address || !city) {
                alert('אנא מלא את כל השדות החובה');
                return;
            }
            
            // Validate email format if provided
            if (email && !email.includes('@')) {
                alert('אנא הזן כתובת אימייל תקינה');
                return;
            }
            
            const editedEmp = modalState.editEmployee;
            const currentEmployeeId = editedEmp.id;
            
            // Check for duplicate name (excluding current employee)
            const duplicateName = employees.find(e => e.id !== currentEmployeeId && e.name.toLowerCase() === name.toLowerCase());
            if (duplicateName) {
                alert('שם זה כבר קיים אצל עובד אחר. אנא בחר שם אחר.');
                return;
            }
            
            // Check for duplicate phone (if phone is provided and not empty)
            if (phone) {
                const duplicatePhone = employees.find(e => e.id !== currentEmployeeId && e.phone && e.phone === phone);
                if (duplicatePhone) {
                    alert('מספר טלפון זה כבר קיים אצל עובד אחר. אנא בחר מספר אחר.');
                    return;
                }
            }
            
            // Check for duplicate email (if email is provided and not empty)
            if (email) {
                const duplicateEmail = employees.find(e => e.id !== currentEmployeeId && e.email && e.email.toLowerCase() === email.toLowerCase());
                if (duplicateEmail) {
                    alert('כתובת אימייל זו כבר קיימת אצל עובד אחר. אנא בחר כתובת אחרת.');
                    return;
                }
            }
            
            const index = employees.findIndex(e => e.id === currentEmployeeId);
            
            if (index !== -1) {
                // Update the employee with new values
                employees[index] = {
                    ...employees[index],
                    name: name,
                    address: address,
                    city: city,
                    phone: phone,
                    email: email,
                    route: route,
                    time: time,
                    // Preserve company/department logic
                    company: department || undefined,
                    department: department || undefined
                };
                // Save to localStorage
                saveEmployees();
                // Close modal and refresh
                hideModal();
                render();
            }
        }

        // פונקציות עזר
        function showSection(section) {
            currentSection = section;
            render();
        }

        async function handleLogin() {
            const usernameInput = document.getElementById('usernameInput');
            const passwordInput = document.getElementById('passwordInput');

            if (!usernameInput || !passwordInput) {
                alert('שגיאה בטעינת הטופס');
                return;
            }

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                alert('אנא מלא את כל השדות');
                return;
            }

            try {
                // Call backend login API
                const response = await fetch(`${API_CONFIG.baseUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Login successful
                    loggedInUserId = data.employee.id;

                    // Update local employees array with logged in employee data
                    const empIndex = employees.findIndex(e => e.id === data.employee.id);
                    if (empIndex >= 0) {
                        employees[empIndex] = { ...employees[empIndex], ...data.employee };
                    }

                    showSection('dashboard');
                } else {
                    // Login failed
                    alert(data.error === 'Invalid credentials' ?
                        'שם משתמש או סיסמה שגויים' :
                        'שגיאה בהתחברות. נסה שוב.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('שגיאה בהתחברות לשרת. ודא שהשרת פועל.');
            }
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('passwordInput');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput && toggleIcon) {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                }
            }
        }

        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            render();
        }


        // Track previous window width to detect mobile->desktop transition
        let previousWidth = window.innerWidth;
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                const currentWidth = window.innerWidth;
                const isDesktop = currentWidth >= 1024;
                const wasMobile = previousWidth < 1024;
                
                // Only auto-open sidebar when transitioning from mobile to desktop
                // This allows the toggle button to work freely on desktop
                if (isDesktop && wasMobile && currentSection !== 'login' && !sidebarOpen) {
                    sidebarOpen = true;
                    render();
                }
                
                previousWidth = currentWidth;
            }, 150);
        });

        function importEmployeesFromExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.ods';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // Get raw data to check if first row is headers
                        const rawData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                        
                        if (rawData.length === 0) {
                            showModal('error', 'הקובץ ריק או לא מכיל נתונים');
                            return;
                        }

                        // Check if data is arranged vertically (all in column A) vs horizontally
                        const firstRow = rawData[0] || [];
                        const hasHorizontalData = firstRow.length > 1; // Multiple columns filled
                        
                        // Check if first row looks like headers (contains common header keywords)
                        const headerKeywords = ['שם', 'name', 'כתובת', 'address', 'עיר', 'city', 'טלפון', 'phone', 'מסלול', 'route', 'שעה', 'time', 'פעיל', 'active'];
                        const firstRowText = firstRow.join(' ').toLowerCase();
                        const hasHeaders = headerKeywords.some(keyword => firstRowText.includes(keyword.toLowerCase()));
                        
                        let jsonData;
                        
                        if (hasHeaders) {
                            // Use headers for mapping
                            jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        } else if (!hasHorizontalData && rawData.length >= 6) {
                            // Data is vertical (all in column A) - transpose it
                            // Group every 6-7 rows into one employee
                            const employees = [];
                            for (let i = 0; i < rawData.length; i += 7) {
                                const name = rawData[i]?.[0] || '';
                                const address = rawData[i + 2]?.[0] || ''; // Skip row 2 (might be department)
                                const city = 'מודיעין'; // Default or extract from address if possible
                                const phone = rawData[i + 3]?.[0] || '';
                                const route = rawData[i + 4]?.[0] || 'מסלול א';
                                let time = rawData[i + 5]?.[0] || '07:00';
                                const active = rawData[i + 6]?.[0] || true;
                                
                                // Convert time format if needed (e.g., "01:00:00 PM" -> "13:00")
                                if (time && typeof time === 'string') {
                                    if (time.includes('PM')) {
                                        const match = time.match(/(\d+):/);
                                        if (match) {
                                            const hour = parseInt(match[1]);
                                            time = `${hour + 12}:00`;
                                        }
                                    } else if (time.includes('AM')) {
                                        const match = time.match(/(\d+):/);
                                        if (match) {
                                            const hour = parseInt(match[1]);
                                            time = `${hour.toString().padStart(2, '0')}:00`;
                                        }
                                    }
                                }
                                
                                if (name && address) {
                                    employees.push({
                                        'שם': name,
                                        'כתובת': address,
                                        'עיר': city,
                                        'טלפון': phone,
                                        'מסלול': route,
                                        'שעה': time,
                                        'פעיל': active === 'פעיל/ה' || active === true || active === 'true'
                                    });
                                }
                            }
                            jsonData = employees;
                        } else {
                            // No headers - assume standard column order: שם, כתובת, עיר, טלפון, מסלול, שעה, פעיל
                            jsonData = rawData.map((row, idx) => {
                                return {
                                    'שם': row[0] || '',
                                    'כתובת': row[1] || '',
                                    'עיר': row[2] || '',
                                    'טלפון': row[3] || '',
                                    'מסלול': row[4] || '',
                                    'שעה': row[5] || '',
                                    'פעיל': row[6] !== undefined ? row[6] : true
                                };
                            });
                        }

                        if (jsonData.length === 0) {
                            showModal('error', 'הקובץ ריק או לא מכיל נתונים');
                            return;
                        }

                        // Map Excel columns to employee object
                        const importedEmployees = jsonData.map((row, index) => {
                            // Try to match common column names (case insensitive, Hebrew/English)
                            const name = row['שם'] || row['name'] || row['Name'] || row['שם עובד'] || '';
                            const address = row['כתובת'] || row['address'] || row['Address'] || row['כתובת מגורים'] || '';
                            const city = row['עיר'] || row['city'] || row['City'] || row['עיר מגורים'] || 'מודיעין';
                            const phone = row['טלפון'] || row['phone'] || row['Phone'] || row['מספר טלפון'] || '';
                            const route = row['מסלול'] || row['route'] || row['Route'] || row['מסלול הסעה'] || 'מסלול א';
                            const time = row['שעה'] || row['time'] || row['Time'] || row['שעת איסוף'] || '07:00';
                            const active = row['פעיל'] !== undefined ? row['פעיל'] : (row['active'] !== undefined ? row['active'] : true);

                            return {
                                id: employees.length + index + 1,
                                name: name,
                                address: address,
                                city: city,
                                phone: phone.toString(),
                                route: route,
                                time: time.toString(),
                                active: active
                            };
                        }).filter(emp => emp.name && emp.address); // Filter out invalid rows

                        if (importedEmployees.length === 0) {
                            showModal('error', 'לא נמצאו עובדים תקינים בקובץ. אנא ודא שהקובץ מכיל נתונים בעמודות: שם, כתובת, עיר, טלפון, מסלול, שעה');
                            return;
                        }

                        // Process imported employees - update existing or add new
                        let updatedCount = 0;
                        let addedCount = 0;
                        let maxId = employees.length > 0 ? Math.max(...employees.map(e => e.id)) : 0;

                        importedEmployees.forEach(importedEmp => {
                            // Try to find existing employee by name (case insensitive)
                            const existingIndex = employees.findIndex(e => 
                                e.name.toLowerCase() === importedEmp.name.toLowerCase()
                            );
                            
                            if (existingIndex !== -1) {
                                // Update existing employee, preserve ID and other fields not in import
                                const existing = employees[existingIndex];
                                employees[existingIndex] = {
                                    ...existing,
                                    ...importedEmp,
                                    id: existing.id, // Keep original ID
                                    username: existing.username || undefined, // Preserve username if exists
                                    password: existing.password || undefined, // Preserve password if exists
                                    email: existing.email || importedEmp.email || undefined, // Preserve email if exists
                                    company: existing.company || existing.department || importedEmp.company || undefined,
                                    department: existing.department || importedEmp.department || undefined
                                };
                                updatedCount++;
                            } else {
                                // Add new employee with new ID
                                importedEmp.id = ++maxId;
                                employees.push(importedEmp);
                                addedCount++;
                            }
                        });

                        saveEmployees();
                        render();
                        const message = updatedCount > 0 && addedCount > 0 
                            ? `עודכנו ${updatedCount} עובדים ו-נוספו ${addedCount} עובדים חדשים בהצלחה!`
                            : updatedCount > 0 
                            ? `עודכנו ${updatedCount} עובדים בהצלחה!`
                            : `נוספו ${addedCount} עובדים חדשים בהצלחה!`;
                        showModal('success', message);
                    } catch (error) {
                        console.error('Error importing Excel:', error);
                        showModal('error', 'שגיאה בקריאת הקובץ. אנא ודא שזה קובץ Excel או ODS תקין (.xlsx, .xls, .ods)');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        }

        function exportEmployeesToExcel() {
            try {
                // Prepare data for export
                const exportData = employees.map(emp => ({
                    'שם': emp.name || '',
                    'כתובת': emp.address || '',
                    'עיר': emp.city || '',
                    'טלפון': emp.phone || '',
                    'מסלול': emp.route || '',
                    'שעה': emp.time || '',
                    'חברה/מחלקה': emp.company || emp.department || '',
                    'אימייל': emp.email || '',
                    'קוד משתמש': emp.username || emp.id || '',
                    'פעיל': emp.active !== undefined ? (emp.active ? 'כן' : 'לא') : 'כן'
                }));

                if (exportData.length === 0) {
                    showModal('error', 'אין עובדים לייצא');
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Set column widths
                const colWidths = [
                    { wch: 20 }, // שם
                    { wch: 25 }, // כתובת
                    { wch: 15 }, // עיר
                    { wch: 15 }, // טלפון
                    { wch: 12 }, // מסלול
                    { wch: 10 }, // שעה
                    { wch: 15 }, // חברה/מחלקה
                    { wch: 25 }, // אימייל
                    { wch: 15 }, // קוד משתמש
                    { wch: 8 }   // פעיל
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'עובדים');

                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
                const filename = `רשימת_עובדים_${dateStr}.xlsx`;

                // Write file - this should trigger browser's save dialog
                // If browser is set to auto-download, it will save to Downloads folder
                // Otherwise, it will prompt for save location
                XLSX.writeFile(wb, filename);
                
                // Note: The browser's save dialog should appear automatically
                // If it doesn't, check your browser's download settings
                showModal('success', `רשימת העובדים מוכנה לייצוא. בחר מיקום שמירה בחלון שמופיע.`);
            } catch (error) {
                console.error('Error exporting Excel:', error);
                showModal('error', 'שגיאה בייצוא הקובץ. אנא נסה שוב.');
            }
        }

        function showImportFormatHelp() {
            const helpText = `פורמט קובץ Excel/ODS לייבוא עובדים:

הקובץ צריך להיות בפורמט .xlsx, .xls או .ods

⚠️ חשוב: הנתונים צריכים להיות מסודרים אופקית (בשורות), לא אנכית (בעמודות)!

אפשרות 1: עם כותרות (מומלץ)
שורה 1: שם | כתובת | עיר | טלפון | מסלול | שעה | פעיל
שורה 2: רז גבאי | שושן צחור 18 | מודיעין | 052-3484-988 | מסלול ו | 13:00 | פעיל/ה

אפשרות 2: ללא כותרות (הכותרות אופציונליות)
שורה 1: רז גבאי | שושן צחור 18 | מודיעין | 052-3484-988 | מסלול ו | 13:00 | פעיל/ה
שורה 2: יוסי כהן | הרצל 15 | תל אביב | 050-1234567 | מסלול א | 07:30 | פעיל/ה

סדר העמודות (אם אין כותרות):
A: שם | B: כתובת | C: עיר | D: טלפון | E: מסלול | F: שעה | G: פעיל

ערכים ברירת מחדל:
• עיר: מודיעין (אם ריק)
• מסלול: מסלול א (אם ריק)
• שעה: 07:00 (אם ריק)
• פעיל: true (אם ריק)

כל שורה = עובד אחד`;
            showModal('info', helpText);
        }

        // מסכים
        function DashboardView() {
            const loggedInEmployee = employees.find(e => e.id === loggedInUserId);
            const greeting = loggedInEmployee ? loggedInEmployee.name : '';
            return `
                <div class="space-y-6">

                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                        <h2 class="text-2xl font-bold flex items-center gap-3" style="color: ${COLORS.primary};">
                            <i class="fas fa-home" style="color: ${COLORS.primary};"></i>
                            דשבורד ראשי
                        </h2>
                        ${greeting ? `<p class="text-lg font-medium text-gray-600"><i class="fas fa-hand-wave ml-1" style="color: ${COLORS.accent};"></i> שלום, <span class="font-bold" style="color: ${COLORS.primary};">${greeting}</span></p>` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

                        <div class="rounded-xl p-6 text-white shadow-lg" style="background: linear-gradient(135deg, ${COLORS.primary} 0%, ${COLORS.primary}dd 100%);">
                            <i class="fas fa-users text-4xl mb-3 opacity-80"></i>

                            <p class="text-3xl font-bold">${getActiveEmployees().length}</p>
                            <p class="text-sm opacity-90">עובדים פעילים</p>
                        </div>
                        

                        <div class="rounded-xl p-6 text-white shadow-lg" style="background: linear-gradient(135deg, ${COLORS.accent} 0%, ${COLORS.accent}dd 100%); color: ${COLORS.primary};">
                            <i class="fas fa-car text-4xl mb-3" style="opacity: 1;"></i>
                            <p class="text-3xl font-bold">${drivers.length}</p>

                            <p class="text-sm opacity-90">נהגים פעילים</p>
                        </div>
                        

                        <div class="rounded-xl p-6 text-white shadow-lg" style="background: linear-gradient(135deg, ${COLORS.primary} 0%, ${COLORS.primary}dd 100%);">
                            <i class="fas fa-route text-4xl mb-3 opacity-80"></i>

                            <p class="text-3xl font-bold">${getRoutes().length}</p>
                            <p class="text-sm opacity-90">מסלולים פעילים</p>
                        </div>
                        

                        <div class="rounded-xl p-6 text-white shadow-lg" style="background: linear-gradient(135deg, ${COLORS.accent} 0%, ${COLORS.accent}dd 100%); color: ${COLORS.primary};">
                            <i class="fas fa-chart-line text-4xl mb-3 opacity-80"></i>
                            <p class="text-3xl font-bold">98%</p>

                            <p class="text-sm opacity-90">שביעות רצון</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">

                                <i class="fas fa-clock" style="color: ${COLORS.primary};"></i>
                                נסיעות היום
                            </h3>
                            <div class="space-y-3">
                                ${drivers.map(driver => `

                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg transition hover:opacity-80" style="background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.05);">
                                        <div class="flex items-center gap-3">

                                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold" style="background-color: ${COLORS.primary};">
                                                ${driver.name[0]}
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-800">${driver.name}</p>
                                                <p class="text-sm text-gray-600">${driver.route}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">

                                            <span class="px-3 py-1 rounded-full text-sm font-bold" style="background-color: ${COLORS.success}33; color: ${COLORS.success}; border: 1px solid ${COLORS.success}66;">פעיל</span>
                                            <span class="px-3 py-1 rounded-full text-sm" style="background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.1); color: ${COLORS.primary}; border: 1px solid rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.3);">${driver.passengers} נוסעים</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">

                                <i class="fas fa-bell" style="color: ${COLORS.accent};"></i>
                                התראות ועדכונים
                            </h3>
                            <div class="space-y-3">

                                ${(() => {
                                    const alerts = getAlerts();
                                    const absentWorkers = getAbsentWorkersToday();
                                    let alertsHtml = '';
                                    
                                    // Show absent workers alert if any
                                    if (absentWorkers.length > 0) {
                                        alertsHtml += `
                                            <div class="p-4 rounded-lg" style="background-color: ${COLORS.error}33; border-right: 4px solid ${COLORS.error};">
                                                <p class="font-bold" style="color: ${COLORS.error}dd;">⚠ ${absentWorkers.join(', ')} לא יגיעו היום</p>
                                                <p class="text-sm" style="color: ${COLORS.error}aa;">${new Date().toLocaleDateString('he-IL')}</p>
                                </div>

                                        `;
                                    }
                                    
                                    // Show user-created alerts
                                    if (alerts.length === 0 && absentWorkers.length === 0) {
                                        alertsHtml += `
                                            <div class="p-4 rounded-lg text-center text-gray-500">
                                                <p>אין התראות חדשות</p>
                                </div>

                                        `;
                                    } else {
                                        alerts.forEach(alert => {
                                            const alertDate = new Date(alert.date);
                                            const now = new Date();
                                            const hoursDiff = Math.floor((now - alertDate) / (1000 * 60 * 60));
                                            const timeText = hoursDiff < 1 ? 'לפני פחות משעה' : hoursDiff === 1 ? 'לפני שעה' : `לפני ${hoursDiff} שעות`;
                                            
                                            alertsHtml += `
                                                <div class="p-4 rounded-lg" style="background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.1); border-right: 4px solid ${COLORS.primary};">
                                                    <p class="font-bold" style="color: ${COLORS.primary}dd;">${alert.text}</p>
                                                    <p class="text-sm" style="color: ${COLORS.primary}aa;">${timeText}</p>
                                </div>

                                            `;
                                        });
                                    }
                                    
                                    return alertsHtml;
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function DriverView() {
            const driver = drivers[0];

            const routeEmployees = getActiveEmployees().filter(e => e.route === driver.route);
            
            return `
                <div class="space-y-6">

                    <div class="rounded-xl p-6 text-white shadow-lg" style="background-color: ${COLORS.primary};">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-bold mb-2">שלום ${driver.name}</h2>

                                <p class="opacity-90">המסלול שלך להיום: ${driver.route}</p>
                            </div>

                            <i class="fas fa-car text-6xl" style="opacity: 1;"></i>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">

                            <i class="fas fa-users" style="color: ${COLORS.primary};"></i>
                            רשימת נוסעים (${routeEmployees.length})
                        </h3>
                        <div class="space-y-3">
                            ${routeEmployees.map((emp, index) => `

                                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg transition hover:opacity-80" style="background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.05);">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold" style="background-color: ${COLORS.primary}; color: white;">
                                        ${index + 1}
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-bold text-gray-800">${emp.name}</p>
                                        <p class="text-sm text-gray-600">
                                            <i class="fas fa-map-marker-alt"></i>
                                            ${emp.address}, ${emp.city}
                                        </p>
                                    </div>

                                        <span class="px-3 py-1 rounded-full text-sm font-bold" style="background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.1); color: ${COLORS.primary}; border: 1px solid rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.3);">
                                            <i class="fas fa-clock"></i>
                                            ${emp.time}
                                        </span>

                                    <a href="tel:${emp.phone}" class="w-12 h-12 rounded-full flex items-center justify-center transition shadow-md" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                            <i class="fas fa-phone"></i>
                                        </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>


                    <div class="rounded-xl p-6 shadow-lg border-2" style="background: linear-gradient(135deg, rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.08) 0%, rgba(${parseInt(COLORS.accent.slice(1, 3), 16)}, ${parseInt(COLORS.accent.slice(3, 5), 16)}, ${parseInt(COLORS.accent.slice(5, 7), 16)}, 0.12) 100%); border-color: ${COLORS.primary}66;">
                        <div class="flex items-start gap-4">

                            <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center shadow-md" style="background-color: ${COLORS.primary};">
                                <i class="fas fa-lightbulb text-2xl text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-xl mb-3" style="color: ${COLORS.primary};">
                                    <i class="fas fa-car-side ml-2" style="color: ${COLORS.accent};"></i>
                                    טיפים לנהג:
                                </h4>
                                <ul class="space-y-2.5" style="color: ${COLORS.textDark};">
                                    <li class="flex items-start gap-2">
                                        <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white mt-0.5" style="background-color: ${COLORS.success};">
                                            <i class="fas fa-check"></i>
                                        </span>
                                        <span class="text-base">בדוק תנאי דרך לפני היציאה</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white mt-0.5" style="background-color: ${COLORS.success};">
                                            <i class="fas fa-check"></i>
                                        </span>
                                        <span class="text-base">התקשר לנוסעים אם יש עיכוב</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white mt-0.5" style="background-color: ${COLORS.success};">
                                            <i class="fas fa-check"></i>
                                        </span>
                                        <span class="text-base">וודא שכל הנוסעים עלו לרכב</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function EmployeeArrangementView() {
            const todayStatus = getDailyTransportationStatus();
            const initialStatus = todayStatus || {};
            
            // Get temporary route assignments (for emergency reassignments)
            const tempRouteAssignments = getTempRouteAssignments();
            
            return `
                <div class="space-y-4 lg:space-y-6">
                    <h2 class="text-xl lg:text-2xl font-bold text-gray-800 flex items-center gap-2 lg:gap-3">
                        <i class="fas fa-users-cog text-lg lg:text-xl" style="color: ${COLORS.primary};"></i>
                        שליחת עובדים - נובולוג
                    </h2>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
                        ${drivers.map(driver => {
                            // Get employees for this route (including temporary reassignments)
                            const routeEmployees = employees.filter(e => {
                                const assignedRoute = tempRouteAssignments[e.id.toString()] || e.route;
                                return assignedRoute === driver.route && e.active;
                            });
                            
                            // Auto-check employees who are not removed/scheduled absent today
                            const comingEmployees = routeEmployees.filter(emp => {
                                const isRemoved = isWorkerRemoved(emp.id);
                                const wasChecked = initialStatus[emp.id.toString()] === true;
                                // Auto-check if not removed and either was checked before or never set
                                return !isRemoved && (wasChecked || initialStatus[emp.id.toString()] === undefined);
                            });
                            
                            // Update initial status for auto-checked employees
                            comingEmployees.forEach(emp => {
                                if (initialStatus[emp.id.toString()] === undefined) {
                                    setEmployeeTransportationStatus(emp.id, true);
                                }
                            });
                            
                            return `
                                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                                    <div class="p-5" style="background-color: ${COLORS.primary};">
                                        <div class="flex items-center justify-between">
                            <div>

                                                <h3 class="text-xl font-bold" style="color: ${COLORS.accent};">${driver.name}</h3>
                                                <p class="text-sm opacity-90" style="color: ${COLORS.accent};">${driver.route} • ${driver.vehicle}</p>
                                            </div>
                                            <i class="fas fa-car text-4xl" style="color: ${COLORS.accent}; opacity: 1;"></i>
                                        </div>
                                    </div>

                                    <div class="p-5">
                                        <div class="mb-4 flex items-center justify-between">
                                            <span class="text-gray-600">עובדים במסלול:</span>
                                            <span class="px-3 py-1 rounded-full font-bold" style="background-color: ${COLORS.primary}; color: white;">${routeEmployees.length}</span>
                                        </div>

                                        <div class="space-y-2 mb-4 max-h-60 overflow-y-auto" 
                                            id="dropzone_${driver.route}" 
                                            ondrop="handleDrop(event, '${driver.route}')" 
                                            ondragover="handleDragOver(event)" 
                                            ondragenter="handleDragEnter(event)"
                                            ondragleave="handleDragLeave(event)"
                                            style="min-height: 100px;">
                                            ${routeEmployees.length > 0 ? routeEmployees.map(emp => {
                                                const isRemoved = isWorkerRemoved(emp.id);
                                                const isChecked = !isRemoved && (initialStatus[emp.id.toString()] === true || initialStatus[emp.id.toString()] === undefined);
                                                
                                                return `
                                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg text-sm ${isRemoved ? 'opacity-50' : ''} employee-item"
                                                    draggable="${!isRemoved ? 'true' : 'false'}"
                                                    ondragstart="handleDragStart(event, ${emp.id})"
                                                    ondragend="handleDragEnd(event)"
                                                    id="emp_item_${emp.id}"
                                                    style="cursor: ${!isRemoved ? 'move' : 'default'};">
                                                    <div class="flex items-center gap-3 flex-1">
                                                        <i class="fas fa-grip-vertical text-gray-400" style="cursor: move;"></i>
                                                        <input type="checkbox" id="emp_${emp.id}" ${isChecked && !isRemoved ? 'checked' : ''} 
                                                            ${isRemoved ? 'disabled' : ''}
                                                            onchange="setEmployeeTransportationStatus(${emp.id}, this.checked)" 
                                                            class="w-5 h-5 rounded border-gray-300" style="accent-color: ${COLORS.primary};">
                                                        <label for="emp_${emp.id}" class="font-medium cursor-pointer flex-1">${emp.name}</label>
                                                    </div>
                                                    <span class="text-gray-600 text-xs">${emp.time}</span>
                                                </div>
                                            `;
                                            }).join('') : `
                                                <div class="text-center p-4 text-gray-500 text-sm">
                                                    גרור עובדים לכאן
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <button onclick="sendToTransportManager()" class="w-full px-6 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                            <i class="fas fa-paper-plane ml-2"></i>
                            שליחת עובדים לאחראי הסעות
                        </button>
                    </div>

                    <div class="rounded-xl p-6" style="background-color: ${COLORS.bgLight}; border: 2px solid ${COLORS.primary};">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-info-circle text-3xl" style="color: ${COLORS.primary};"></i>
                            <div>
                                <h4 class="font-bold text-lg mb-2" style="color: ${COLORS.textDark};">הערות חשובות:</h4>
                                <ul class="space-y-1" style="color: ${COLORS.textDark};">
                                    <li>• העובדים מסומנים אוטומטית כבאים (אלא אם הוסרו/בוטלו)</li>
                                    <li>• ניתן לשנות מסלול עובד במקרה חירום (נהג חולה וכו')</li>
                                    <li>• לחץ על "שליחת עובדים לאחראי הסעות" לעדכן את המידע</li>
                                    <li>• המידע מתעדכן אוטומטית ב"אחראי הסעות"</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // פונקציות לניהול שינוי מסלול זמני (temporary route reassignment)
        function getTempRouteAssignments() {
            const today = getTodayDateString();
            const stored = localStorage.getItem('tempRouteAssignments');
            const allAssignments = stored ? JSON.parse(stored) : {};
            return allAssignments[today] || {};
        }

        function saveTempRouteAssignments(assignments) {
            const today = getTodayDateString();
            const stored = localStorage.getItem('tempRouteAssignments');
            const allAssignments = stored ? JSON.parse(stored) : {};
            allAssignments[today] = assignments;
            localStorage.setItem('tempRouteAssignments', JSON.stringify(allAssignments));
        }

        function changeEmployeeRoute(employeeId, newRoute) {
            const today = getTodayDateString();
            const stored = localStorage.getItem('tempRouteAssignments');
            const allAssignments = stored ? JSON.parse(stored) : {};
            if (!allAssignments[today]) {
                allAssignments[today] = {};
            }
            allAssignments[today][employeeId.toString()] = newRoute;
            localStorage.setItem('tempRouteAssignments', JSON.stringify(allAssignments));
            
            // Refresh the view
            render();
        }

        // Drag and Drop functions
        let draggedEmployeeId = null;

        function handleDragStart(e, employeeId) {
            draggedEmployeeId = employeeId;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
            e.currentTarget.style.opacity = '0.5';
        }

        function handleDragEnd(e) {
            e.currentTarget.style.opacity = '1';
            // Remove drag-over styling from all dropzones
            document.querySelectorAll('[id^="dropzone_"]').forEach(zone => {
                zone.style.backgroundColor = '';
                zone.style.borderColor = '';
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.currentTarget.id && e.currentTarget.id.startsWith('dropzone_')) {
                e.currentTarget.style.backgroundColor = 'rgba(80, 116, 128, 0.1)';
                e.currentTarget.style.borderColor = '#507480';
                e.currentTarget.style.borderStyle = 'dashed';
                e.currentTarget.style.borderWidth = '2px';
            }
        }

        function handleDragLeave(e) {
            if (e.currentTarget.id && e.currentTarget.id.startsWith('dropzone_')) {
                e.currentTarget.style.backgroundColor = '';
                e.currentTarget.style.borderColor = '';
                e.currentTarget.style.borderStyle = '';
                e.currentTarget.style.borderWidth = '';
            }
        }

        function handleDrop(e, targetRoute) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            if (e.preventDefault) {
                e.preventDefault();
            }

            // Remove drag-over styling
            e.currentTarget.style.backgroundColor = '';
            e.currentTarget.style.borderColor = '';
            e.currentTarget.style.borderStyle = '';
            e.currentTarget.style.borderWidth = '';

            if (draggedEmployeeId && targetRoute) {
                changeEmployeeRoute(draggedEmployeeId, targetRoute);
            }

            return false;
        }

        function showDriverMessageModal(driverName) {
            modalState = {
                show: true,
                type: 'driver-message',
                driverName: driverName,
                message: `ההודעה נשלחה ל-${driverName}`
            };
            render();
        }

        function sendToTransportManager() {
            // Collect all checkbox states
            const todayStatus = {};
            employees.forEach(emp => {
                const checkbox = document.getElementById(`emp_${emp.id}`);
                if (checkbox) {
                    todayStatus[emp.id.toString()] = checkbox.checked;
                } else {
                    // If checkbox doesn't exist (removed employee), set to false
                    const isRemoved = isWorkerRemoved(emp.id);
                    todayStatus[emp.id.toString()] = !isRemoved;
                }
            });
            
            // Save the status
            saveDailyTransportationStatus(todayStatus);
            
            // Show modal and switch to transport manager view
            modalState = {
                show: true,
                type: 'transport-manager-message',
                message: 'נשלח סידור לאחראי הסעות'
            };
            render();
            
            // Switch to transport manager view after a short delay
            setTimeout(() => {
                hideModal();
                showSection('transport-manager');
            }, 2000);
        }

        function TransportManagerView() {

            const todayStatus = getDailyTransportationStatus();
            const hasData = todayStatus !== null;
            const tempRouteAssignments = getTempRouteAssignments();
            
            return `

                <div class="space-y-4 lg:space-y-6">
                    <h2 class="text-xl lg:text-2xl font-bold text-gray-800 flex items-center gap-2 lg:gap-3">
                        <i class="fas fa-paper-plane text-lg lg:text-xl" style="color: ${COLORS.primary};"></i>
                        שליחת סידור לנהגים
                    </h2>


                    ${!hasData ? `
                        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6 text-center">
                            <i class="fas fa-exclamation-triangle text-3xl mb-3" style="color: ${COLORS.accent};"></i>
                            <p class="text-lg font-bold" style="color: ${COLORS.textDark};">אין נתונים זמינים עדיין</p>
                            <p class="text-sm mt-2" style="color: ${COLORS.textDark};">אנא המתן לעדכון מ"סידור עובדים"</p>
                        </div>
                    ` : `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${drivers.map(driver => {

                            // Filter employees by route (including temporary reassignments) and check if they're coming today
                            const routeEmployees = employees.filter(e => {
                                const assignedRoute = tempRouteAssignments[e.id.toString()] || e.route;
                                return assignedRoute === driver.route && e.active;
                            });
                            const comingEmployees = routeEmployees.filter(emp => {
                                const status = isEmployeeComingToday(emp.id);
                                return status === true; // Only show if explicitly marked as coming
                            });
                            
                            return `
                                <div class="bg-white rounded-xl shadow-lg overflow-hidden">

                                    <div class="p-5" style="background-color: ${COLORS.primary};">
                                        <div class="flex items-center justify-between">
                                            <div>

                                                <h3 class="text-xl font-bold" style="color: ${COLORS.accent};">${driver.name}</h3>
                                                <p class="text-sm opacity-90" style="color: ${COLORS.accent};">${driver.route} • ${driver.vehicle}</p>
                                            </div>

                                            <i class="fas fa-car text-4xl" style="color: ${COLORS.accent}; opacity: 1;"></i>
                                        </div>
                                    </div>

                                    <div class="p-5">
                                        <div class="mb-4 flex items-center justify-between">
                                            <span class="text-gray-600">נוסעים במסלול:</span>

                                            <span class="px-3 py-1 rounded-full font-bold" style="background-color: ${COLORS.primary}; color: white;">${comingEmployees.length}</span>
                                        </div>

                                        <div class="space-y-2 mb-4 max-h-60 overflow-y-auto">

                                            ${comingEmployees.length > 0 ? comingEmployees.map(emp => `
                                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg text-sm">
                                                    <span class="font-medium">${emp.name}</span>
                                                    <span class="text-gray-600">${emp.time}</span>
                                                </div>

                                            `).join('') : `
                                                <div class="text-center p-4 text-gray-500 text-sm">
                                                    אין נוסעים במסלול זה היום
                                                </div>
                                            `}
                                        </div>


                                        <button onclick="showDriverMessageModal('${driver.name}')" class="w-full py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                            <i class="fas fa-paper-plane ml-2"></i>
                                            שלח סידור ל-${driver.name}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    `}

                    <div class="rounded-xl p-4 lg:p-6" style="background-color: ${COLORS.bgLight}; border: 2px solid ${COLORS.primary};">
                        <div class="flex items-start gap-2 lg:gap-4">
                            <i class="fas fa-info-circle text-2xl lg:text-3xl flex-shrink-0" style="color: ${COLORS.primary};"></i>
                            <div>

                                <h4 class="font-bold text-base lg:text-lg mb-1 lg:mb-2" style="color: ${COLORS.textDark};">הערות חשובות:</h4>
                                <ul class="space-y-1 text-sm lg:text-base" style="color: ${COLORS.textDark};">
                                    <li>• כל נהג מקבל רק את המסלול שלו</li>
                                    <li>• הסידור כולל שמות, כתובות ומספרי טלפון</li>
                                    <li>• הנהגים מקבלים עדכונים</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function EmployeesView() {
            return `

                <div class="space-y-4 lg:space-y-6">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                        <h2 class="text-xl lg:text-2xl font-bold text-gray-800 flex items-center gap-2 lg:gap-3">
                            <i class="fas fa-users text-lg lg:text-xl" style="color: ${COLORS.primary};"></i>
                            רשימת עובדים
                        </h2>

                        <div class="flex items-center gap-2 lg:gap-3 w-full sm:w-auto">
                            <button onclick="showImportFormatHelp()" class="p-2 rounded-lg transition hover:opacity-80" style="color: ${COLORS.primary}; background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.1);" title="פורמט קובץ Excel">
                                <i class="fas fa-question-circle text-lg lg:text-xl"></i>
                        </button>
                            <button onclick="importEmployeesFromExcel()" class="text-white px-3 lg:px-4 py-2 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 flex-1 sm:flex-none" style="background-color: ${COLORS.primary};">
                                <i class="fas fa-file-excel ml-1 lg:ml-2"></i>
                                <span class="hidden sm:inline">ייבוא עובדים</span>
                                <span class="sm:hidden">ייבוא</span>
                            </button>
                            <button onclick="exportEmployeesToExcel()" class="text-white px-3 lg:px-4 py-2 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 flex-1 sm:flex-none" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                <i class="fas fa-download ml-1 lg:ml-2"></i>
                                <span class="hidden sm:inline">ייצוא עובדים</span>
                                <span class="sm:hidden">ייצוא</span>
                        </button>

                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">

                        <div class="overflow-x-auto" style="scrollbar-width: thin; -webkit-overflow-scrolling: touch;">
                            <div class="min-w-full inline-block align-middle">
                                <table class="w-full min-w-[800px] lg:min-w-0">
                                <thead style="background-color: ${COLORS.primary};">
                                    <tr>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">שם</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">חברה/מחלקה</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">כתובת</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">טלפון</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">מסלול</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">שעת איסוף</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">סטטוס</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">

                                    ${getActiveEmployees().map(emp => `
                                        <tr class="hover:bg-gray-50 transition">

                                            <td class="px-3 lg:px-6 py-3 lg:py-4 font-medium text-sm lg:text-base text-gray-800 whitespace-nowrap">${emp.name}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-sm whitespace-nowrap">${emp.company || emp.department || '-'}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-sm whitespace-nowrap">${emp.address}, ${emp.city}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-sm whitespace-nowrap">${emp.phone}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                <span class="px-2 lg:px-3 py-1 rounded-full text-xs lg:text-sm font-medium whitespace-nowrap inline-block" style="background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.1); color: ${COLORS.primary}; border: 1px solid rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.3);">
                                                    ${emp.route}
                                                </span>
                                            </td>

                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-base font-medium whitespace-nowrap">${emp.time}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                <span class="px-2 lg:px-3 py-1 rounded-full text-xs lg:text-sm font-medium whitespace-nowrap inline-block" style="${emp.active ? `background-color: ${COLORS.success}33; color: ${COLORS.success}dd; border: 1px solid ${COLORS.success}66;` : `background-color: ${COLORS.error}33; color: ${COLORS.error}dd; border: 1px solid ${COLORS.error}66;`}">
                                                    ${emp.active ? 'פעיל/ה' : 'לא פעיל/ה'}
                                                </span>
                                            </td>

                                            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                <div class="flex items-center gap-1 lg:gap-2">
                                                    <button onclick="handleEdit(${emp.id})" class="p-1 lg:p-2 rounded transition flex-shrink-0 hover:opacity-80" style="color: ${COLORS.primary}; background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.05);" title="עריכה">
                                                        <i class="fas fa-edit text-sm lg:text-base"></i>
                                                    </button>

                                                    <button onclick="handleSelfRemoval(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')" class="p-1 lg:p-2 rounded transition flex-shrink-0 hover:opacity-80" style="color: ${COLORS.error}; background-color: ${COLORS.error}22;" title="הסרה זמנית">
                                                        <i class="fas fa-trash-alt text-sm lg:text-base"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}

                                    
                                    ${getRemovedEmployees().length > 0 ? `
                                        <tr class="bg-gray-100 border-t-4 border-gray-300">
                                            <td colspan="8" class="px-3 lg:px-6 py-2 lg:py-3">
                                                <h3 class="text-base lg:text-lg font-bold text-gray-600">נעדרים</h3>
                                            </td>
                                        </tr>
                                        ${getRemovedEmployees().map(emp => `
                                            <tr class="hover:bg-gray-50 transition" style="opacity: 0.6; background-color: #f9fafb;">
                                                <td class="px-3 lg:px-6 py-3 lg:py-4 font-medium text-sm lg:text-base text-gray-500 whitespace-nowrap">${emp.name}</td>
                                                <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-400 text-xs lg:text-sm whitespace-nowrap">${emp.company || emp.department || '-'}</td>
                                                <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-400 text-xs lg:text-sm whitespace-nowrap">${emp.address}, ${emp.city}</td>
                                                <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-400 text-xs lg:text-sm whitespace-nowrap">${emp.phone}</td>
                                                <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                    <span class="bg-gray-200 text-gray-500 px-2 lg:px-3 py-1 rounded-full text-xs lg:text-sm font-medium whitespace-nowrap inline-block">
                                                        ${emp.route}
                                                    </span>
                                                </td>
                                                <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-400 text-xs lg:text-base font-medium whitespace-nowrap">${emp.time}</td>
                                                <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                    <span class="px-2 lg:px-3 py-1 rounded-full text-xs lg:text-sm font-medium whitespace-nowrap inline-block" style="background-color: ${COLORS.error}33; color: ${COLORS.error}dd; border: 1px solid ${COLORS.error}66;">
                                                        לא פעיל/ה
                                                    </span>
                                                </td>
                                                <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                    <button onclick="restoreWorker(${emp.id})" class="px-2 lg:px-4 py-1 lg:py-2 rounded-lg text-xs lg:text-base font-bold transition shadow-md hover:opacity-90 text-white whitespace-nowrap" style="background-color: ${COLORS.primary};">
                                                        שחזור
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    ` : ''}
                                </tbody>
                            </table>

                            </div>
                        </div>
                        <div class="lg:hidden px-3 py-2 bg-gray-50 border-t border-gray-200 text-center">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-arrows-alt-h ml-1"></i>
                                גלול ימינה ושמאלה כדי לראות את כל המידע
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }


        function EmployeeManagementView() {
            return `

                <div class="space-y-4 lg:space-y-6">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                        <h2 class="text-xl lg:text-2xl font-bold text-gray-800 flex items-center gap-2 lg:gap-3">
                            <i class="fas fa-user-cog text-lg lg:text-xl" style="color: ${COLORS.primary};"></i>
                            ניהול עובדים
                        </h2>

                        <div class="flex items-center gap-2 lg:gap-3 w-full sm:w-auto">
                            <button onclick="addEmployeeModalState.show = true; render();" class="px-3 lg:px-4 py-2 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 flex-1 sm:flex-none text-white" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                <i class="fas fa-plus ml-1 lg:ml-2"></i>
                                <span class="hidden sm:inline">הוספת עובדים</span>
                                <span class="sm:hidden">הוספה</span>
                        </button>

                        </div>
                    </div>

                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">

                        <div class="overflow-x-auto" style="scrollbar-width: thin; -webkit-overflow-scrolling: touch;">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead style="background-color: ${COLORS.primary};">
                                    <tr>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">שם</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">חברה/מחלקה</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">כתובת</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">טלפון</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">מסלול</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">שעת איסוף</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">קוד משתמש</th>
                                        <th class="px-3 lg:px-6 py-3 lg:py-4 text-right text-xs lg:text-sm font-bold text-white">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${employees.length === 0 ? `
                                        <tr>
                                            <td colspan="8" class="px-3 lg:px-6 py-8 text-center text-gray-500">
                                                אין עובדים במערכת
                                            </td>
                                        </tr>
                                    ` : employees.map(emp => `
                                        <tr class="hover:bg-gray-50 transition">
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 font-medium text-sm lg:text-base text-gray-900 whitespace-nowrap">${emp.name}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-sm whitespace-nowrap">${emp.company || emp.department || '-'}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-sm whitespace-nowrap">${emp.address}, ${emp.city}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-sm whitespace-nowrap">${emp.phone}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                <span class="bg-gray-200 text-gray-700 px-2 lg:px-3 py-1 rounded-full text-xs lg:text-sm font-medium whitespace-nowrap inline-block">
                                                    ${emp.route}
                                                </span>
                                            </td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-base font-medium whitespace-nowrap">${emp.time}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 text-gray-600 text-xs lg:text-sm whitespace-nowrap">${emp.username || emp.id || '-'}</td>
                                            <td class="px-3 lg:px-6 py-3 lg:py-4 whitespace-nowrap">
                                                <button onclick="deleteEmployeePermanently(${emp.id})" class="p-1 lg:p-2 rounded transition flex-shrink-0 hover:opacity-80" style="color: ${COLORS.error}; background-color: ${COLORS.error}22;" title="מחיקה לצמיתות">
                                                    <i class="fas fa-trash-alt text-sm lg:text-base"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            </div>
                                    </div>
                                    </div>

            `;
        }

        function deleteEmployeePermanently(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return;
            
            showModal('confirm-delete-employee', `האם אתה בטוח שברצונך למחוק את העובד "${employee.name}" לצמיתות? פעולה זו לא ניתנת לביטול.`, () => {
                const index = employees.findIndex(e => e.id === employeeId);
                if (index !== -1) {
                    // Check if the deleted employee is the currently logged-in user
                    const isDeletingSelf = loggedInUserId === employeeId;
                    
                    employees.splice(index, 1);
                    saveEmployees();
                    
                    // Also remove from removed workers list
                    const removedWorkers = getRemovedWorkers();
                    delete removedWorkers[employeeId];
                    delete removedWorkers[employeeId.toString()];
                    saveRemovedWorkers(removedWorkers);
                    
                    // If user deleted themselves, log them out and redirect to login
                    if (isDeletingSelf) {
                        loggedInUserId = null;
                        modalState = { show: false, type: '', message: '', onConfirm: null, workerId: null, workerName: null };
                        currentSection = 'login';
                        render();
                        showModal('success', 'החשבון נמחק בהצלחה. אתה מועבר למסך ההתחברות.');
                    } else {
                        render();
                        showModal('success', 'העובד נמחק בהצלחה');
                    }
                }
            });
        }

        async function saveNewEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            const department = document.getElementById('newEmployeeDepartment').value.trim();
            const address = document.getElementById('newEmployeeAddress').value.trim();
            const city = document.getElementById('newEmployeeCity').value.trim();
            const phone = document.getElementById('newEmployeePhone').value.trim();
            const email = document.getElementById('newEmployeeEmail')?.value.trim() || '';
            const route = document.getElementById('newEmployeeRoute').value;
            const time = document.getElementById('newEmployeeTime').value;
            const username = document.getElementById('newEmployeeUsername').value.trim();
            const password = document.getElementById('newEmployeePassword').value.trim();
            
            if (!name || !address || !city || !username || !password) {
                showModal('error', 'אנא מלא את כל השדות החובה');
                return;
            }
            
            // Validate email format if provided
            if (email && !email.includes('@')) {
                showModal('error', 'אנא הזן כתובת אימייל תקינה');
                return;
            }
            
            // Check for duplicate name
            const duplicateName = employees.find(e => e.name.toLowerCase() === name.toLowerCase());
            if (duplicateName) {
                showModal('error', 'שם זה כבר קיים אצל עובד אחר. אנא בחר שם אחר.');
                return;
            }
            
            // Check for duplicate username
            const duplicateUsername = employees.find(e => e.username && e.username.toLowerCase() === username.toLowerCase());
            if (duplicateUsername) {
                showModal('error', 'קוד משתמש זה כבר קיים. אנא בחר קוד אחר.');
                return;
            }
            
            // Check for duplicate phone (if phone is provided)
            if (phone) {
                const duplicatePhone = employees.find(e => e.phone && e.phone === phone);
                if (duplicatePhone) {
                    showModal('error', 'מספר טלפון זה כבר קיים אצל עובד אחר. אנא בחר מספר אחר.');
                    return;
                }
            }
            
            // Check for duplicate email (if email is provided)
            if (email) {
                const duplicateEmail = employees.find(e => e.email && e.email.toLowerCase() === email.toLowerCase());
                if (duplicateEmail) {
                    showModal('error', 'כתובת אימייל זו כבר קיימת אצל עובד אחר. אנא בחר כתובת אחרת.');
                    return;
                }
            }
            
            // Generate new ID
            const newId = employees.length > 0 ? Math.max(...employees.map(e => e.id)) + 1 : 1;
            
            // Create new employee via backend API
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/employees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username, password, name, department,
                        company: department, address, city, phone,
                        email: email || null, route, time, active: true
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Add to local array for immediate UI update
                    employees.push({
                        id: data.id,
                        name, department, company: department,
                        address, city, phone, email, route, time,
                        active: true, username
                    });

                    addEmployeeModalState.show = false;
                    render();
                    showModal('success', 'העובד נוסף בהצלחה למסד הנתונים!');
                } else {
                    showModal('error', data.error === 'Username or worker code already exists' ?
                        'שם משתמש זה כבר קיים' : 'שגיאה בהוספת עובד. נסה שוב.');
                }
            } catch (error) {
                console.error('Add employee error:', error);
                showModal('error', 'שגיאה בחיבור לשרת. ודא שהשרת פועל.');
            }
        }

        // Route management functions
        function getRoutes() {
            const stored = localStorage.getItem('routes');
            if (stored) {
                return JSON.parse(stored);
            }
            // Initialize routes from employees
            const routeMap = {};
            employees.forEach(emp => {
                if (emp.active && emp.route) {
                    if (!routeMap[emp.route]) {
                        routeMap[emp.route] = {
                            name: emp.route,
                            locations: [],
                            driver: drivers.find(d => d.route === emp.route)?.name || '',
                            employees: []
                        };
                    }
                    routeMap[emp.route].employees.push(emp);
                    // Add location if not already exists
                    const locationKey = `${emp.city}:${emp.address}`;
                    if (!routeMap[emp.route].locations.find(l => l.key === locationKey)) {
                        routeMap[emp.route].locations.push({
                            key: locationKey,
                            city: emp.city,
                            address: emp.address,
                            fullAddress: `${emp.address}, ${emp.city}`
                        });
                    }
                }
            });
            return Object.values(routeMap);
        }

        function saveRoute(routeName, locations, departureTime) {
            const routes = getRoutes();
            const existingIndex = routes.findIndex(r => r.name === routeName);
            const routeData = {
                name: routeName,
                locations: locations,
                departureTime: departureTime || '07:00',
                driver: drivers.find(d => d.route === routeName)?.name || '',
                employees: employees.filter(e => e.route === routeName && e.active)
            };
            if (existingIndex >= 0) {
                routes[existingIndex] = routeData;
            } else {
                routes.push(routeData);
            }
            localStorage.setItem('routes', JSON.stringify(routes));
        }

        function deleteRoute(routeName) {
            modalState = {
                show: true,
                type: 'confirm-delete-route',
                message: `האם אתה בטוח שברצונך למחוק את ${routeName}?`,
                routeName: routeName,
                onConfirm: function() {
                    const routes = getRoutes();
                    const filteredRoutes = routes.filter(r => r.name !== routeName);
                    localStorage.setItem('routes', JSON.stringify(filteredRoutes));
                    hideModal();
                    render();
                }
            };
            render();
        }

        function formatRouteByTown(locations) {
            const townMap = {};
            locations.forEach(loc => {
                const city = loc.city || loc.town || 'לא צוין';
                if (!townMap[city]) {
                    townMap[city] = [];
                }
                townMap[city].push(loc.address || loc.fullAddress || loc.name || '');
            });
            return townMap;
        }

        function openAddRouteModal(routeNameToEdit = null) {
            const routeToEdit = routeNameToEdit ? getRoutes().find(r => r.name === routeNameToEdit) : null;
            
            routeModalState = {
                show: true,
                routeName: routeToEdit ? routeToEdit.name : '',
                selectedLocations: routeToEdit ? (routeToEdit.locations || []) : [],
                departureTime: routeToEdit ? (routeToEdit.departureTime || '07:00') : '07:00',
                map: null,
                markers: [],
                isEditing: !!routeToEdit
            };
            render();
            // Initialize map after render
            setTimeout(() => {
                initRouteMap();
            }, 100);
        }

        function initRouteMap() {
            const mapContainer = document.getElementById('route-map-container');
            if (!mapContainer || !window.L) {
                console.warn('Leaflet.js not loaded');
                return;
            }

            // If map already exists, sync markers with selectedLocations
            if (routeModalState.map) {
                // Create a map of location keys to track which markers should exist
                const locationKeys = new Set();
                routeModalState.selectedLocations.forEach((loc, idx) => {
                    const key = loc.lat && loc.lng ? `${loc.lat.toFixed(6)}:${loc.lng.toFixed(6)}` : `${idx}:${loc.key}`;
                    locationKeys.add(key);
                });
                
                // Remove markers that don't have corresponding locations
                const markersToKeep = [];
                routeModalState.markers.forEach((marker, idx) => {
                    const loc = routeModalState.selectedLocations[idx];
                    if (loc && loc.lat && loc.lng) {
                        const key = `${loc.lat.toFixed(6)}:${loc.lng.toFixed(6)}`;
                        if (locationKeys.has(key)) {
                            markersToKeep.push(marker);
                        } else {
                            routeModalState.map.removeLayer(marker);
                        }
                    } else {
                        routeModalState.map.removeLayer(marker);
                    }
                });
                routeModalState.markers = markersToKeep;
                
                // Add markers for locations that don't have markers yet
                routeModalState.selectedLocations.forEach((loc, idx) => {
                    if (loc.lat && loc.lng) {
                        // Check if we already have a marker at this position
                        const hasMarker = routeModalState.markers.some(marker => {
                            const pos = marker.getLatLng();
                            return Math.abs(pos.lat - loc.lat) < 0.0001 && Math.abs(pos.lng - loc.lng) < 0.0001;
                        });
                        
                        if (!hasMarker) {
                            addMarkerToMap(loc.lat, loc.lng, loc);
                        }
                    }
                });
                
                // Refresh map size (in case container was resized)
                setTimeout(() => {
                    routeModalState.map.invalidateSize();
                }, 100);
                
                return;
            }

            // Center on Israel
            const israelCenter = [31.7683, 35.2137];
            routeModalState.map = L.map(mapContainer).setView(israelCenter, 8);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(routeModalState.map);

            // Add click handler to map
            routeModalState.map.on('click', function(e) {
                if (isGeocoding) {
                    return; // Prevent multiple simultaneous requests
                }
                
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // Validate coordinates
                if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    console.error('Invalid coordinates:', lat, lng);
                    return;
                }
                
                // Reverse geocode to get address
                reverseGeocode(lat, lng);
            });

            // Add existing markers if any
            routeModalState.selectedLocations.forEach(loc => {
                if (loc.lat && loc.lng) {
                    addMarkerToMap(loc.lat, loc.lng, loc);
                }
            });
        }

        function reverseGeocode(lat, lng) {
            if (isGeocoding) return;
            
            isGeocoding = true;
            
            // Show loading indicator
            const loadingMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'loading-marker',
                    html: '<div style="background-color: ' + COLORS.accent + '; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(routeModalState.map);
            
            // Use Nominatim (OpenStreetMap's free geocoding service) with proper headers
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=he`, {
                headers: {
                    'User-Agent': 'TransportSystem/1.0'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Remove loading marker
                    routeModalState.map.removeLayer(loadingMarker);
                    
                    if (!data || data.error) {
                        throw new Error(data.error || 'No data returned');
                    }
                    
                    const address = data.address || {};
                    const city = address.city || address.town || address.municipality || address.county || address.state || 'לא צוין';
                    const street = address.road || address.pedestrian || '';
                    const houseNumber = address.house_number || '';
                    const fullAddress = houseNumber && street ? `${street} ${houseNumber}` : street || (data.display_name ? data.display_name.split(',')[0] : 'לא צוין');
                    
                    const location = {
                        key: `${city}:${fullAddress}:${lat.toFixed(4)}:${lng.toFixed(4)}`,
                        city: city,
                        address: fullAddress,
                        fullAddress: `${fullAddress}, ${city}`,
                        lat: lat,
                        lng: lng
                    };

                    // Check if already exists (with tolerance for similar coordinates)
                    const existingLocation = routeModalState.selectedLocations.find(l => 
                        Math.abs(l.lat - lat) < 0.0001 && Math.abs(l.lng - lng) < 0.0001
                    );
                    
                    if (!existingLocation) {
                        routeModalState.selectedLocations.push(location);
                        addMarkerToMap(lat, lng, location);
                        updateRouteModalLocationsList();
                    } else {
                        alert('מיקום זה כבר קיים ברשימה');
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    // Remove loading marker
                    routeModalState.map.removeLayer(loadingMarker);
                    
                    // Fallback: add with coordinates and show user-friendly message
                    const location = {
                        key: `${lat.toFixed(4)}:${lng.toFixed(4)}`,
                        city: 'לא צוין',
                        address: `קואורדינטות: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                        fullAddress: `קואורדינטות: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                        lat: lat,
                        lng: lng
                    };
                    
                    const existingLocation = routeModalState.selectedLocations.find(l => 
                        Math.abs(l.lat - lat) < 0.0001 && Math.abs(l.lng - lng) < 0.0001
                    );
                    
                    if (!existingLocation) {
                        routeModalState.selectedLocations.push(location);
                        addMarkerToMap(lat, lng, location);
                        updateRouteModalLocationsList();
                    }
                })
                .finally(() => {
                    isGeocoding = false;
                });
        }

        function updateRouteModalLocationsList() {
            // Update only the locations list DOM without destroying the map
            const locationsContainer = document.getElementById('route-locations-list');
            const countLabel = document.querySelector('[data-locations-count]');
            
            if (!locationsContainer) return;
            
            const locations = routeModalState.selectedLocations;
            
            // Update count label
            if (countLabel) {
                countLabel.textContent = `מיקומים נבחרים (${locations.length})`;
            }
            
            // Update locations list
            if (locations.length === 0) {
                locationsContainer.innerHTML = `
                    <p class="text-gray-500 text-center text-sm lg:text-base py-6">
                        <i class="fas fa-info-circle ml-2"></i>
                        אין מיקומים נבחרים. הוסף מיקומים באמצעות הטופס למעלה.
                    </p>
                `;
            } else {
                locationsContainer.innerHTML = locations.map((loc, index) => `
                    <div class="flex items-center justify-between p-3 lg:p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex-1 text-right">
                            <p class="font-bold text-sm lg:text-base text-gray-800 flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-xs" style="color: ${COLORS.primary};"></i>
                                ${loc.city}
                            </p>
                            <p class="text-xs lg:text-sm text-gray-600 mt-1">${loc.address}</p>
                                    </div>

                        <button onclick="removeLocationFromRoute(${index})" class="ml-3 p-2 rounded transition flex-shrink-0 hover:opacity-80" style="color: ${COLORS.error}; background-color: ${COLORS.error}22;">
                            <i class="fas fa-times text-sm lg:text-base"></i>
                        </button>
                                </div>

                `).join('');
            }
        }

        function addMarkerToMap(lat, lng, location) {
            if (!routeModalState.map) return;
            
            try {
                // Validate coordinates
                if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    console.error('Invalid coordinates for marker:', lat, lng);
                    return;
                }
                
                const marker = L.marker([lat, lng]).addTo(routeModalState.map);
                marker.bindPopup(`<b>${location.city}</b><br>${location.address}`);
                routeModalState.markers.push(marker);
                
                // Fit map to show all markers (only if we have valid bounds)
                if (routeModalState.markers.length > 0) {
                    try {
                        const group = new L.featureGroup(routeModalState.markers);
                        const bounds = group.getBounds();
                        if (bounds.isValid()) {
                            routeModalState.map.fitBounds(bounds.pad(0.1));
                        }
                    } catch (boundsError) {
                        console.warn('Could not fit bounds:', boundsError);
                        // Just center on the new marker if bounds fail
                        routeModalState.map.setView([lat, lng], routeModalState.map.getZoom());
                    }
                }
            } catch (error) {
                console.error('Error adding marker:', error);
            }
        }

        function addLocationToRoute() {
            const cityInput = document.getElementById('route-city-input');
            const addressInput = document.getElementById('route-address-input');
            
            const city = cityInput?.value.trim() || '';
            const address = addressInput?.value.trim() || '';

            if (!city || !address) {
                alert('אנא הזן עיר וכתובת');
                return;
            }

            // Try to geocode the address
            const searchQuery = `${address}, ${city}, Israel`;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1&accept-language=he`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);
                        
                        const location = {
                            key: `${city}:${address}`,
                            city: city,
                            address: address,
                            fullAddress: `${address}, ${city}`,
                            lat: lat,
                            lng: lng
                        };

                        if (!routeModalState.selectedLocations.find(l => l.key === location.key)) {
                            routeModalState.selectedLocations.push(location);
                            if (routeModalState.map) {
                                addMarkerToMap(lat, lng, location);
                            }
                            
                            // Clear inputs
                            if (cityInput) cityInput.value = '';
                            if (addressInput) addressInput.value = '';
                            
                            updateRouteModalLocationsList();
                        } else {
                            alert('מיקום זה כבר קיים ברשימה');
                        }
                    } else {
                        // If geocoding fails, add without coordinates
                        const location = {
                            key: `${city}:${address}`,
                            city: city,
                            address: address,
                            fullAddress: `${address}, ${city}`
                        };

                        if (!routeModalState.selectedLocations.find(l => l.key === location.key)) {
                            routeModalState.selectedLocations.push(location);
                            if (cityInput) cityInput.value = '';
                            if (addressInput) addressInput.value = '';
                            updateRouteModalLocationsList();
                        } else {
                            alert('מיקום זה כבר קיים ברשימה');
                        }
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    // Fallback: add without coordinates
                    const location = {
                        key: `${city}:${address}`,
                        city: city,
                        address: address,
                        fullAddress: `${address}, ${city}`
                    };

                    if (!routeModalState.selectedLocations.find(l => l.key === location.key)) {
                        routeModalState.selectedLocations.push(location);
                        if (cityInput) cityInput.value = '';
                        if (addressInput) addressInput.value = '';
                        render();
                    } else {
                        alert('מיקום זה כבר קיים ברשימה');
                    }
                });
        }

        function removeLocationFromRoute(index) {
            if (index < 0 || index >= routeModalState.selectedLocations.length) {
                return;
            }
            
            const locationToRemove = routeModalState.selectedLocations[index];
            
            // Remove location from array first
            routeModalState.selectedLocations.splice(index, 1);
            
            // Find and remove the corresponding marker by matching coordinates
            if (locationToRemove.lat && locationToRemove.lng && routeModalState.map) {
                const markerIndex = routeModalState.markers.findIndex(marker => {
                    const pos = marker.getLatLng();
                    return Math.abs(pos.lat - locationToRemove.lat) < 0.0001 && 
                           Math.abs(pos.lng - locationToRemove.lng) < 0.0001;
                });
                
                if (markerIndex >= 0 && routeModalState.markers[markerIndex]) {
                    routeModalState.map.removeLayer(routeModalState.markers[markerIndex]);
                    routeModalState.markers.splice(markerIndex, 1);
                }
            } else if (routeModalState.markers[index]) {
                // Fallback: remove by index if no coordinates
                routeModalState.map.removeLayer(routeModalState.markers[index]);
                routeModalState.markers.splice(index, 1);
            }
            
            // Refit map if there are remaining markers
            if (routeModalState.markers.length > 0 && routeModalState.map) {
                try {
                    const group = new L.featureGroup(routeModalState.markers);
                    const bounds = group.getBounds();
                    if (bounds.isValid()) {
                        routeModalState.map.fitBounds(bounds.pad(0.1));
                    }
                } catch (e) {
                    console.warn('Could not fit bounds:', e);
                }
            }
            
            // Update UI without re-rendering the entire modal (which would destroy the map)
            updateRouteModalLocationsList();
        }

        function saveNewRoute() {
            if (!routeModalState.routeName) {
                alert('אנא הזן שם מסלול');
                return;
            }
            if (routeModalState.selectedLocations.length === 0) {
                alert('אנא בחר לפחות מיקום אחד');
                return;
            }

            const departureTime = document.getElementById('route-departure-time')?.value || routeModalState.departureTime || '07:00';
            saveRoute(routeModalState.routeName, routeModalState.selectedLocations, departureTime);
            
            // Clean up map
            if (routeModalState.map) {
                routeModalState.map.remove();
            }
            routeModalState = { show: false, routeName: '', selectedLocations: [], departureTime: '07:00', map: null, markers: [], isEditing: false };
            render();
        }

        function viewFullRoute(routeName) {
            const routes = getRoutes();
            const route = routes.find(r => r.name === routeName);
            if (!route) {
                alert('מסלול לא נמצא');
                return;
            }

            const townMap = formatRouteByTown(route.locations);

            modalState = {
                show: true,
                type: 'route-view',
                routeName: routeName,
                townMap: townMap
            };
            render();
        }

        function RoutesView() {
            const routes = getRoutes();
            
            return `
                <div class="space-y-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <h2 class="text-xl lg:text-2xl font-bold text-gray-800 flex items-center gap-2 lg:gap-3">
                            <i class="fas fa-route text-lg lg:text-xl" style="color: ${COLORS.primary};"></i>
                            ניהול מסלולים
                        </h2>
                        <button onclick="openAddRouteModal()" class="px-3 lg:px-4 py-2 rounded-lg font-bold transition shadow-md hover:opacity-90 text-sm lg:text-base" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                            <i class="fas fa-plus ml-2"></i>
                            הוסף מסלול
                                </button>
                            </div>

                    ${routes.length === 0 ? `
                        <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                            <i class="fas fa-route text-4xl mb-4" style="color: ${COLORS.primary};"></i>
                            <p class="text-lg font-bold text-gray-600 mb-2">אין מסלולים זמינים</p>
                            <p class="text-sm text-gray-500">לחץ על "הוסף מסלול" כדי להתחיל</p>
                        </div>

                    ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
                        ${routes.map((route, index) => {
                            const townMap = formatRouteByTown(route.locations);
                            const mainCity = Object.keys(townMap)[0] || 'לא צוין';
                            const employeeCount = route.employees.length;
                            const departureTime = route.departureTime || (route.employees.length > 0 
                                ? route.employees.reduce((min, emp) => {
                                    const empTime = emp.time || '99:99';
                                    return empTime < min ? empTime : min;
                                }, route.employees[0].time || '99:99')
                                : '--:--');
                            
                            return `
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">

                                    <div class="p-4 lg:p-5 text-white" style="background: linear-gradient(135deg, ${COLORS.primary} 0%, ${COLORS.primary}dd 100%);">
                                        <h3 class="text-lg lg:text-xl font-bold">${route.name}</h3>
                                        <p class="text-sm lg:text-base opacity-90 mt-1">${mainCity}</p>
                            </div>

                                    <div class="p-4 lg:p-5">
                                        <div class="space-y-2 lg:space-y-3 mb-4">
                                    <div class="flex justify-between items-center">

                                                <span class="text-gray-600 text-sm lg:text-base">נהג:</span>
                                                <span class="font-bold text-sm lg:text-base">${route.driver || 'לא הוגדר'}</span>
                                    </div>
                                    <div class="flex justify-between items-center">

                                                <span class="text-gray-600 text-sm lg:text-base">עובדים:</span>
                                                <span class="font-bold text-sm lg:text-base">${employeeCount}</span>
                                    </div>
                                    <div class="flex justify-between items-center">

                                                <span class="text-gray-600 text-sm lg:text-base">זמן יציאה:</span>
                                                <span class="font-bold text-sm lg:text-base">${departureTime}</span>
                                    </div>
                                </div>

                                        <div class="flex gap-2">
                                            <button onclick="viewFullRoute('${route.name}')" class="flex-1 py-2 lg:py-2.5 rounded-lg font-bold transition shadow-md hover:opacity-90 text-sm lg:text-base" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                    צפה במסלול המלא
                                </button>

                                            <button onclick="openAddRouteModal('${route.name}')" class="px-3 lg:px-4 py-2 lg:py-2.5 rounded-lg font-bold transition shadow-md hover:opacity-90 text-sm lg:text-base" style="background-color: ${COLORS.primary}; color: white;" title="ערוך מסלול">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteRoute('${route.name}')" class="px-3 lg:px-4 py-2 lg:py-2.5 rounded-lg font-bold transition shadow-md hover:opacity-90 text-sm lg:text-base text-white" style="background-color: ${COLORS.error};" title="מחק מסלול">
                                                <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                            `;
                        }).join('')}
                    </div>
                    `}
                </div>
            `;
        }


        function generateYearDates() {
            const dates = [];
            const currentYear = new Date().getFullYear();
            const startDate = new Date(currentYear, 0, 1); // January 1
            const endDate = new Date(currentYear, 11, 31); // December 31
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                dates.push(`${year}-${month}-${day}`);
            }
            return dates;
        }

        function toggleDateSelection(date) {
            if (selectedCancellationDates.has(date)) {
                selectedCancellationDates.delete(date);
            } else {
                selectedCancellationDates.add(date);
            }
            render();
        }

        function cancelSelectedRides() {
            if (selectedCancellationDates.size === 0) {
                alert('אנא בחר לפחות תאריך אחד');
                return;
            }
            
            if (!loggedInUserId) {
                alert('אנא התחבר תחילה');
                return;
            }
            
            const workerId = loggedInUserId;
            const datesArray = Array.from(selectedCancellationDates);
            
            addScheduledCancellation(workerId, datesArray);
            selectedCancellationDates.clear();
            
            alert(`בוטלו ${datesArray.length} נסיעות בהצלחה!`);
            render();
        }

        function EmployeePortalView() {

            if (!loggedInUserId) {
                return '<div class="text-center p-4 lg:p-6 text-sm lg:text-base">אנא התחבר כדי לצפות בבקשות שלך</div>';
            }
            
            const yearDates = generateYearDates();
            const scheduledCancellations = getScheduledCancellations();
            const workerId = loggedInUserId;
            const workerCancellations = scheduledCancellations[workerId.toString()] || [];
            
            // Group dates by month for better display
            const datesByMonth = {};
            yearDates.forEach(date => {
                const month = date.substring(0, 7); // YYYY-MM
                if (!datesByMonth[month]) {
                    datesByMonth[month] = [];
                }
                datesByMonth[month].push(date);
            });

            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];

            return `

                <div class="space-y-4 lg:space-y-6">
                    <h2 class="text-xl lg:text-2xl font-bold text-gray-800 flex items-center gap-2 lg:gap-3">
                        <i class="fas fa-user text-lg lg:text-xl" style="color: ${COLORS.primary};"></i>
                        הבקשות שלי
                    </h2>


                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">

                            <h3 class="text-xl font-bold mb-4 text-gray-800">בקשות</h3>
                            <div class="space-y-3">

                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-600">קוד עובד/ת:</span>
                                    <span class="font-bold">${employees.find(e => e.id === workerId)?.workerCode || employees.find(e => e.id === workerId)?.id || 'לא נמצא'}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-600">מסלול:</span>
                                    <span class="font-bold">מסלול א</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-600">שעת איסוף:</span>
                                    <span class="font-bold">07:12</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="text-gray-600">נהג:</span>

                                    <span class="font-bold">${(() => {
                                        const employee = employees.find(e => e.id === workerId);
                                        if (employee) {
                                            const driver = drivers.find(d => d.route === employee.route);
                                            return driver ? driver.name : 'רפי';
                                        }
                                        return 'רפי';
                                    })()}</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">ביטול הסעה</h3>

                            <p class="text-gray-600 mb-4 text-sm">בחר תאריכים שברצונך לבטל (ניתן לבחור מספר תאריכים):</p>
                            
                            <div class="max-h-96 overflow-y-auto border-2 border-gray-200 rounded-lg p-2 lg:p-4 mb-4" style="max-height: 400px;">
                                ${Object.keys(datesByMonth).sort().map(month => {
                                    const monthNum = parseInt(month.substring(5, 7));
                                    const monthName = monthNames[monthNum - 1];
                                    return `
                                        <div class="mb-3 lg:mb-4">
                                            <h4 class="font-bold text-sm lg:text-base text-gray-700 mb-2 sticky top-0 bg-white py-1">${monthName} ${month.substring(0, 4)}</h4>
                                            <div class="grid grid-cols-7 gap-0.5 lg:gap-1">
                                                ${datesByMonth[month].map(date => {
                                                    const day = parseInt(date.substring(8, 10));
                                                    const isSelected = selectedCancellationDates.has(date);
                                                    const isCancelled = workerCancellations.includes(date);
                                                    const isPast = date < getTodayDateString();
                                                    
                                                    return `
                                                        <button 
                                                            onclick="toggleDateSelection('${date}')" 
                                                            class="p-2 text-sm rounded transition ${isPast ? 'opacity-50 cursor-not-allowed' : ''} ${isSelected ? 'text-white font-bold' : isCancelled ? 'bg-gray-300 text-gray-700' : 'bg-gray-100 hover:bg-gray-200 text-gray-800'}"
                                                            style="${isSelected ? `background-color: ${COLORS.error};` : ''}"
                                                            ${isPast ? 'disabled' : ''}
                                                            title="${date}"
                                                        >
                                                            ${day}
                            </button>

                                                    `;
                                                }).join('')}
                        </div>

                                        </div>
                                    `;
                                }).join('')}
                    </div>


                            ${selectedCancellationDates.size > 0 ? `
                                <div class="mb-4 p-3 rounded-lg border-2" style="background-color: ${COLORS.error}33; border-color: ${COLORS.error}66;">
                                    <p class="text-sm font-bold" style="color: ${COLORS.error}dd;">נבחרו ${selectedCancellationDates.size} תאריכים</p>
                                </div>
                            ` : ''}
                            
                            <button onclick="cancelSelectedRides()" class="w-full text-white py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.error};">
                                בטל נסיעה
                            </button>
                        </div>
                    </div>

                    <div class="rounded-xl p-6 border-2" style="background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.1); border-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.3);">
                        <div class="flex items-start gap-4">

                            <i class="fas fa-info-circle text-3xl" style="color: ${COLORS.primary};"></i>
                            <div>

                                <h4 class="font-bold text-lg mb-2" style="color: ${COLORS.primary}dd;">מידע חשוב:</h4>
                                <ul class="space-y-1" style="color: ${COLORS.primary}aa;">
                                    <li>• ניתן לבחור מספר תאריכים ולבטל בבת אחת</li>
                                    <li>• תאריכים שכבר בוטלו מסומנים באפור</li>
                                    <li>• עדכונים על המסלול יישלחו באימייל</li>
                                    <li>• שאלות? צרו קשר עם מחלקת ההסעות</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        function generateMonthlyTransportReport(year, month) {
            // Get all dates in the month
            const daysInMonth = new Date(year, month, 0).getDate();
            const monthStr = String(month).padStart(2, '0');
            
            let totalTrips = 0;
            let totalPassengers = 0;
            const routeUsage = {};
            let totalCancellations = 0;
            let totalScheduled = 0;
            
            // Get scheduled cancellations
            const cancellations = getScheduledCancellations();
            const removedWorkers = getRemovedWorkers();
            
            // Calculate for each day in the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = String(day).padStart(2, '0');
                const dateStr = `${year}-${monthStr}-${dayStr}`;
                const date = new Date(year, month - 1, day);
                
                // Skip future dates
                if (date > new Date()) continue;
                
                // Count active employees per route for this day
                const employeesByRoute = {};
                let dayPassengers = 0;
                let dayCancellations = 0;
                
                employees.forEach(emp => {
                    if (!emp.active) return;
                    
                    const route = emp.route;
                    if (!employeesByRoute[route]) {
                        employeesByRoute[route] = 0;
                    }
                    
                    // Check if employee was cancelled this day
                    const isCancelled = isWorkerScheduledAbsent(emp.id, dateStr) || 
                                       (removedWorkers[emp.id] && removedWorkers[emp.id] === dateStr) ||
                                       (removedWorkers[emp.id.toString()] && removedWorkers[emp.id.toString()] === dateStr);
                    
                    if (isCancelled) {
                        dayCancellations++;
                    } else {
                        employeesByRoute[route]++;
                        dayPassengers++;
                    }
                });
                
                // Count trips (one trip per route with passengers)
                Object.keys(employeesByRoute).forEach(route => {
                    if (employeesByRoute[route] > 0) {
                        totalTrips++;
                        totalPassengers += employeesByRoute[route];
                        
                        if (!routeUsage[route]) {
                            routeUsage[route] = 0;
                        }
                        routeUsage[route]++;
                    }
                });
                
                totalScheduled += employees.filter(e => e.active).length;
                totalCancellations += dayCancellations;
            }
            
            // Find most used route
            const routeKeys = Object.keys(routeUsage);
            const mostUsedRoute = routeKeys.length > 0 
                ? routeKeys.reduce((a, b) => routeUsage[a] > routeUsage[b] ? a : b) 
                : 'אין נתונים';
            
            const avgPassengersPerTrip = totalTrips > 0 ? (totalPassengers / totalTrips).toFixed(1) : 0;
            const cancellationRate = totalScheduled > 0 ? ((totalCancellations / totalScheduled) * 100).toFixed(1) : 0;
            
            return {
                totalTrips,
                avgPassengersPerTrip,
                mostUsedRoute,
                cancellationRate,
                routeUsage,
                totalPassengers,
                totalCancellations,
                totalScheduled
            };
        }

        async function exportMonthlyReportToPDF(year, month, reportData) {
            try {
                const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני',
                                    'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
                const monthName = monthNames[month - 1];
                const chartColors = ['#1e3a8a', '#fbbf24', '#10b981', '#ef4444', '#8b5cf6', '#f97316'];
                const routeEntries = Object.entries(reportData.routeUsage).sort((a, b) => b[1] - a[1]);
                const activeCount = reportData.totalScheduled - reportData.totalCancellations;

                // --- Render charts locally as base64 images FIRST ---
                const renderChart = (config, width, height) => {
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    document.body.appendChild(canvas);
                    const chart = new Chart(canvas, config);
                    const img = canvas.toDataURL('image/png');
                    chart.destroy();
                    document.body.removeChild(canvas);
                    return img;
                };

                let pieImage = '', barImage = '';
                if (routeEntries.length > 0) {
                    pieImage = renderChart({
                        type: 'pie',
                        data: { labels: routeEntries.map(([r]) => r), datasets: [{ data: routeEntries.map(([, c]) => c), backgroundColor: chartColors.slice(0, routeEntries.length), borderWidth: 2, borderColor: '#fff' }] },
                        options: { responsive: false, animation: false, plugins: { title: { display: true, text: 'התפלגות מסלולים', font: { size: 15, weight: 'bold' } }, legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 10 } } } }
                    }, 400, 320);

                    barImage = renderChart({
                        type: 'bar',
                        data: { labels: routeEntries.map(([r]) => r), datasets: [{ label: 'נסיעות', data: routeEntries.map(([, c]) => c), backgroundColor: chartColors.slice(0, routeEntries.length), borderWidth: 1, borderColor: '#e5e7eb', borderRadius: 6 }] },
                        options: { responsive: false, animation: false, plugins: { title: { display: true, text: 'נסיעות לפי מסלול', font: { size: 15, weight: 'bold' } }, legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    }, 400, 320);
                }

                const doughnutImage = renderChart({
                    type: 'doughnut',
                    data: { labels: ['נסיעות פעילות', 'ביטולים'], datasets: [{ data: [activeCount, reportData.totalCancellations], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 2, borderColor: '#fff' }] },
                    options: { responsive: false, animation: false, plugins: { title: { display: true, text: 'פעילות מול ביטולים', font: { size: 15, weight: 'bold' } }, legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 10 } } } }
                }, 350, 300);

                // Build route table rows
                const routeRows = routeEntries.map(([route, count], i) => {
                    const percentage = reportData.totalTrips > 0
                        ? ((count / reportData.totalTrips) * 100).toFixed(1) : '0';
                    return `<tr style="background:${i % 2 === 0 ? '#f5f7fa' : '#fff'}">
                        <td style="padding:8px 16px;border-bottom:1px solid #e5e7eb">${route}</td>
                        <td style="padding:8px 16px;border-bottom:1px solid #e5e7eb;text-align:center">${count}</td>
                        <td style="padding:8px 16px;border-bottom:1px solid #e5e7eb;text-align:center">${percentage}%</td>
                    </tr>`;
                }).join('');

                // Build pure HTML with embedded images (no external scripts needed)
                const html = `<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
<meta charset="UTF-8">
<title>דוח הסעות - ${monthName} ${year}</title>
<style>
    @media print {
        body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        .no-print { display: none !important; }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, 'Segoe UI', Tahoma, sans-serif; background: #fff; color: #333; direction: rtl; }
    .header { background: #1e3a8a; color: #fff; padding: 24px 40px; text-align: center; }
    .header h1 { font-size: 28px; margin-bottom: 6px; }
    .header h2 { font-size: 16px; font-weight: 400; opacity: 0.9; }
    .content { padding: 24px 40px; max-width: 800px; margin: 0 auto; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 28px; }
    .stat-card { border-radius: 10px; padding: 16px; text-align: center; color: #fff; }
    .stat-card .value { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
    .stat-card .label { font-size: 13px; opacity: 0.9; }
    .section-title { font-size: 18px; font-weight: bold; color: #1e3a8a; margin: 20px 0 12px; border-bottom: 2px solid #fbbf24; padding-bottom: 6px; }
    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .chart-container { background: #f9fafb; border-radius: 10px; padding: 16px; text-align: center; }
    .chart-container img { max-width: 100%; height: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th { background: #1e3a8a; color: #fff; padding: 10px 16px; text-align: right; font-size: 14px; }
    td { font-size: 14px; }
    .footer { text-align: center; color: #999; font-size: 11px; padding: 20px; border-top: 1px solid #eee; margin-top: 24px; }
    .print-btn { display: block; margin: 20px auto; padding: 12px 40px; background: #1e3a8a; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .print-btn:hover { opacity: 0.9; }
</style>
</head>
<body>
    <div class="header">
        <h1>דוח הסעות חודשי</h1>
        <h2>${monthName} ${year}</h2>
    </div>
    <div class="content">
        <div class="stats-grid">
            <div class="stat-card" style="background:#1e3a8a">
                <div class="value">${reportData.totalTrips}</div>
                <div class="label">סה"כ נסיעות</div>
            </div>
            <div class="stat-card" style="background:#10b981">
                <div class="value">${reportData.avgPassengersPerTrip}</div>
                <div class="label">ממוצע נוסעים לנסיעה</div>
            </div>
            <div class="stat-card" style="background:#f59e0b">
                <div class="value">${reportData.mostUsedRoute || '-'}</div>
                <div class="label">מסלול מוביל</div>
            </div>
            <div class="stat-card" style="background:#ef4444">
                <div class="value">${reportData.cancellationRate}%</div>
                <div class="label">אחוז ביטולים</div>
            </div>
        </div>

        ${routeEntries.length > 0 ? `
        <div class="section-title">התפלגות מסלולים</div>
        <div class="charts-row">
            <div class="chart-container"><img src="${pieImage}"></div>
            <div class="chart-container"><img src="${barImage}"></div>
        </div>
        ` : ''}

        <div class="section-title">נסיעות פעילות מול ביטולים</div>
        <div style="max-width:350px;margin:0 auto 20px">
            <div class="chart-container"><img src="${doughnutImage}"></div>
        </div>

        <div class="section-title">פירוט לפי מסלול</div>
        <table>
            <thead>
                <tr>
                    <th>מסלול</th>
                    <th style="text-align:center">מספר נסיעות</th>
                    <th style="text-align:center">אחוז מהסה"כ</th>
                </tr>
            </thead>
            <tbody>
                ${routeRows || '<tr><td colspan="3" style="text-align:center;padding:16px;color:#999">אין נתונים לחודש זה</td></tr>'}
            </tbody>
        </table>

        <div class="footer">דוח הסעות - ${monthName} ${year} | הופק אוטומטית ממערכת ניהול ההסעות</div>
    </div>

    <button class="print-btn no-print" onclick="window.print(); window.onafterprint = function(){ window.close(); };">הדפס / שמור כ-PDF</button>
</body>
</html>`;

                // Open print window
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    showModal('error', 'החלון נחסם. אנא אפשר חלונות קופצים (pop-ups) עבור אתר זה.');
                    return;
                }
                printWindow.document.write(html);
                printWindow.document.close();

                showModal('success', 'הדוח נפתח בחלון חדש. לחץ על "הדפס / שמור כ-PDF" או השתמש ב-Ctrl+P.');
            } catch (error) {
                console.error('Error exporting PDF report:', error);
                showModal('error', 'שגיאה בייצוא הדוח. אנא נסה שוב.');
            }
        }

        function updateMonthlyReport() {
            const year = parseInt(document.getElementById('reportYear').value);
            const month = parseInt(document.getElementById('reportMonth').value);
            render();
        }

        async function exportCurrentReport() {
            const year = parseInt(document.getElementById('reportYear')?.value || new Date().getFullYear());
            const month = parseInt(document.getElementById('reportMonth')?.value || new Date().getMonth() + 1);
            const reportData = generateMonthlyTransportReport(year, month);
            await exportMonthlyReportToPDF(year, month, reportData);
        }

        function ReportsView() {

            // Default to current month
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // Generate report for current month
            const reportData = generateMonthlyTransportReport(currentYear, currentMonth);
            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 
                               'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            
            return `

                <div class="space-y-4 lg:space-y-6">
                    <h2 class="text-xl lg:text-2xl font-bold text-gray-800 flex items-center gap-2 lg:gap-3 justify-center sm:justify-start text-center sm:text-right">
                        <i class="fas fa-chart-bar text-lg lg:text-xl" style="color: ${COLORS.primary};"></i>
                        דוחות וסטטיסטיקות
                    </h2>


                    <!-- Date Selection -->
                    <div class="bg-white rounded-xl shadow-lg p-6 text-center sm:text-right">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">בחר חודש לדוח</h3>
                        <div class="flex flex-col sm:flex-row gap-4 items-stretch sm:items-end">
                            <div class="flex-1">
                                <label class="block text-gray-700 font-medium mb-2">חודש</label>
                                <div class="relative">
                                    <select id="reportMonth" class="w-full border-2 border-gray-300 rounded-lg p-3 pl-10 outline-none transition bg-white appearance-none" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};">
                                        ${monthNames.map((name, idx) => `
                                            <option value="${idx + 1}" ${currentMonth === idx + 1 ? 'selected' : ''}>${name}</option>
                                        `).join('')}
                                    </select>
                                    <i class="fas fa-chevron-down absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="block text-gray-700 font-medium mb-2">שנה</label>
                                <div class="relative">
                                    <select id="reportYear" class="w-full border-2 border-gray-300 rounded-lg p-3 pl-10 outline-none transition bg-white appearance-none" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};">
                                        ${Array.from({ length: 11 }, (_, i) => 2020 + i).map(year => `
                                            <option value="${year}" ${currentYear === year ? 'selected' : ''}>${year}</option>
                                        `).join('')}
                                    </select>
                                    <i class="fas fa-chevron-down absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none"></i>
                                </div>
                            </div>
                            <button onclick="updateMonthlyReport()" class="px-6 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 text-white whitespace-nowrap w-full sm:w-auto" style="background-color: ${COLORS.primary};">
                                <i class="fas fa-search ml-2"></i>
                                הצג דוח
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 lg:gap-4">
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">

                            <div class="text-4xl font-bold mb-2" style="color: ${COLORS.primary};">${reportData.totalTrips}</div>
                            <div class="text-gray-600">סה"כ נסיעות החודש</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">

                            <div class="text-4xl font-bold mb-2" style="color: ${COLORS.success};">${reportData.avgPassengersPerTrip}</div>
                            <div class="text-gray-600">ממוצע נוסעים לנסיעה</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">

                            <div class="text-3xl font-bold mb-2" style="color: ${COLORS.accent};">${reportData.mostUsedRoute}</div>
                            <div class="text-gray-600">המסלול הכי בשימוש</div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <div class="text-4xl font-bold mb-2" style="color: ${COLORS.error};">${reportData.cancellationRate}%</div>
                            <div class="text-gray-600">אחוז ביטולים</div>
                        </div>
                    </div>


                    <!-- Route Usage Details -->
                    <div class="bg-white rounded-xl shadow-lg p-6">

                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 text-center sm:text-right">
                            <h3 class="text-xl font-bold text-gray-800">פירוט לפי מסלול</h3>
                            <button onclick="exportCurrentReport()" class="px-4 py-2 rounded-lg font-bold transition shadow-md hover:opacity-90 text-white text-sm w-full sm:w-auto" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                <i class="fas fa-print ml-2"></i>
                                הדפס דוח / PDF
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead style="background-color: ${COLORS.primary};">
                                    <tr>
                                        <th class="px-4 py-3 text-right text-sm font-bold text-white">מסלול</th>
                                        <th class="px-4 py-3 text-right text-sm font-bold text-white">מספר נסיעות</th>
                                        <th class="px-4 py-3 text-right text-sm font-bold text-white">אחוז מהסה"כ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${Object.keys(reportData.routeUsage).length > 0 ? Object.entries(reportData.routeUsage)
                                        .sort((a, b) => b[1] - a[1])
                                        .map(([route, count]) => {
                                            const percentage = reportData.totalTrips > 0 
                                                ? ((count / reportData.totalTrips) * 100).toFixed(1) 
                                                : 0;
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-3 text-gray-900 font-medium">${route}</td>
                                                    <td class="px-4 py-3 text-gray-600">${count}</td>
                                                    <td class="px-4 py-3 text-gray-600">${percentage}%</td>
                                                </tr>
                                            `;
                                        }).join('') : `
                                        <tr>
                                            <td colspan="3" class="px-4 py-3 text-center text-gray-500">אין נתונים לחודש זה</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function LoginView() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gray-100">
                    <div class="max-w-md w-full mx-4">

                        <div class="rounded-xl shadow-lg overflow-hidden" style="background-color: ${COLORS.primary};">
                            <div class="w-full flex items-center justify-center gap-3 px-6 py-6" style="background-color: ${COLORS.accent};">
                                <i class="fas fa-car text-4xl" style="color: ${COLORS.primary};"></i>
                                <h2 class="text-2xl font-bold" style="color: ${COLORS.primary};">מערכת הסעות</h2>
                            </div>

                            <form onsubmit="event.preventDefault(); handleLogin();" class="p-8 space-y-4">
                                <div>

                                    <label class="block text-white font-medium mb-2">קוד משתמש (מספר עובד או שם)</label>
                                    <input type="text" id="usernameInput" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="הכנס מספר עובד (1-7) או שם">
                                </div>
                                <div>
                                    <label class="block text-white font-medium mb-2">סיסמה</label>

                                    <div class="relative">
                                        <input type="password" id="passwordInput" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="הכנס סיסמה (ברירת מחדל: 1234)">
                                        <button type="button" onclick="togglePasswordVisibility()" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none z-10">
                                            <i id="passwordToggleIcon" class="fas fa-eye-slash"></i>
                                        </button>
                                </div>

                                </div>
                                <button type="submit" class="w-full py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                    התחברות
                                </button>
                            </form>


                            <div class="mt-1 text-center">
                                <a href="#" onclick="event.preventDefault(); openForgotPasswordModal();" class="text-white hover:opacity-80 text-sm">שכחת סיסמה?</a>
                            </div>

                            <div class="mt-6 pt-6 border-t border-white border-opacity-30 text-center">
                                <p class="text-white text-sm mb-3 opacity-90">עדיין לא רשום?</p>

                                <button onclick="openRegisterModal()" class="w-full text-white py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                    <i class="fas fa-user-plus ml-2"></i>
                                    רישום למערכת
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // רכיב מודאל
        function ModalComponent() {
            if (!modalState.show) return '';

            if (modalState.type === 'edit') {
                const emp = modalState.editEmployee;
                if (!emp) return '';
                
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style="background-color: ${COLORS.modalBackdrop};">
                        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                            <div class="p-8">
                                <div class="text-center mb-6">
                                    <i class="fas fa-user-edit text-5xl mb-4" style="color: ${COLORS.accent};"></i>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">עריכת עובד</h3>
                                </div>
                                
                                <form onsubmit="event.preventDefault(); saveEmployeeEdit();" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">שם</label>
                                            <input type="text" id="editName" value="${emp.name || ''}" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">חברה/מחלקה</label>
                                            <input type="text" id="editDepartment" value="${emp.company || emp.department || ''}" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">כתובת</label>
                                            <input type="text" id="editAddress" value="${emp.address || ''}" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">עיר</label>
                                            <input type="text" id="editCity" value="${emp.city || ''}" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">טלפון</label>
                                            <input type="tel" id="editPhone" value="${emp.phone || ''}" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">אימייל</label>
                                            <input type="email" id="editEmail" value="${emp.email || ''}" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="user@example.com">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">מסלול</label>
                                            <select id="editRoute" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                                <option value="מסלול א" ${emp.route === 'מסלול א' ? 'selected' : ''}>מסלול א</option>
                                                <option value="מסלול ב" ${emp.route === 'מסלול ב' ? 'selected' : ''}>מסלול ב</option>
                                                <option value="מסלול ג" ${emp.route === 'מסלול ג' ? 'selected' : ''}>מסלול ג</option>
                                                <option value="מסלול ד" ${emp.route === 'מסלול ד' ? 'selected' : ''}>מסלול ד</option>
                                                <option value="מסלול ה" ${emp.route === 'מסלול ה' ? 'selected' : ''}>מסלול ה</option>
                                                <option value="מסלול ו" ${emp.route === 'מסלול ו' ? 'selected' : ''}>מסלול ו</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-gray-700 font-medium mb-2">שעת איסוף</label>
                                            <input type="time" id="editTime" value="${emp.time || '07:00'}" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-3 justify-center mt-6">
                                        <button type="button" onclick="hideModal()" class="px-8 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.bgLight}; color: ${COLORS.textDark};">
                                            ביטול
                                        </button>
                                        <button type="submit" class="px-8 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                            שמור שינויים
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'confirm') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style="background-color: ${COLORS.modalBackdrop};" onclick="event.target === event.currentTarget && hideModal()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                            <div class="p-8">
                                <div class="text-center mb-6">
                                    <i class="fas fa-question-circle text-5xl mb-4" style="color: ${COLORS.primary};"></i>
                                    <h3 class="text-xl font-bold text-gray-800 mb-3">אישור מחיקה</h3>
                                    <p class="text-gray-600 text-lg">${modalState.message}</p>
                                </div>
                                <div class="flex gap-3 justify-center">
                                    <button onclick="hideModal()" class="px-8 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.bgLight}; color: ${COLORS.textDark};">
                                        ביטול
                                    </button>
                                    <button onclick="confirmModalAction()" class="px-8 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.primary};">
                                        אישור
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'confirm-delete-route') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: ${COLORS.modalBackdrop};" onclick="event.target === event.currentTarget && hideModal()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-4 lg:mb-6">
                                    <i class="fas fa-exclamation-triangle text-4xl lg:text-5xl mb-3 lg:mb-4" style="color: ${COLORS.error};"></i>
                                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-2 lg:mb-3">מחיקת מסלול</h3>
                                    <p class="text-gray-600 text-base lg:text-lg">${modalState.message}</p>
                                </div>
                                <div class="flex gap-3 justify-center">
                                    <button onclick="hideModal()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.bgLight}; color: ${COLORS.textDark};">
                                        ביטול
                                    </button>
                                    <button onclick="confirmModalAction()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.error};">
                                        <i class="fas fa-trash ml-2"></i>
                                        מחק
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'confirm-delete-employee') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: ${COLORS.modalBackdrop};" onclick="event.target === event.currentTarget && hideModal()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-4 lg:mb-6">
                                    <i class="fas fa-exclamation-triangle text-4xl lg:text-5xl mb-3 lg:mb-4" style="color: ${COLORS.error};"></i>
                                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-2 lg:mb-3">מחיקת עובד לצמיתות</h3>
                                    <p class="text-gray-600 text-base lg:text-lg">${modalState.message}</p>
                                </div>
                                <div class="flex gap-3 justify-center">
                                    <button onclick="hideModal()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.bgLight}; color: ${COLORS.textDark};">
                                        ביטול
                                    </button>
                                    <button onclick="confirmModalAction()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.error};">
                                        <i class="fas fa-trash-alt ml-2"></i>
                                        מחק לצמיתות
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'success') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: rgba(80, 116, 128, 0.7);" onclick="event.target === event.currentTarget && confirmModalAction()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-4 lg:mb-6">
                                    <i class="fas fa-check-circle text-4xl lg:text-5xl mb-3 lg:mb-4" style="color: ${COLORS.success};"></i>
                                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-2 lg:mb-3">הצלחה</h3>
                                    <p class="text-gray-600 text-base lg:text-lg">${modalState.message}</p>
                                </div>
                                <div class="flex justify-center">
                                    <button onclick="confirmModalAction()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.primary};">
                                        סגור
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'driver-message') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: ${COLORS.modalBackdrop};" onclick="event.target === event.currentTarget && hideModal()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-4 lg:mb-6">
                                    <i class="fas fa-paper-plane text-4xl lg:text-5xl mb-3 lg:mb-4" style="color: ${COLORS.accent};"></i>
                                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-2 lg:mb-3">הודעה נשלחה</h3>
                                    <p class="text-gray-600 text-base lg:text-lg">${modalState.message}</p>
                                </div>
                                <div class="flex justify-center">
                                    <button onclick="hideModal()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.primary};">
                                        סגור
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'transport-manager-message') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: ${COLORS.modalBackdrop};" onclick="event.target === event.currentTarget && hideModal(); showSection('transport-manager');">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-4 lg:mb-6">
                                    <i class="fas fa-paper-plane text-4xl lg:text-5xl mb-3 lg:mb-4" style="color: ${COLORS.accent};"></i>
                                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-2 lg:mb-3">הודעה נשלחה</h3>
                                    <p class="text-gray-600 text-base lg:text-lg">${modalState.message}</p>
                                </div>
                                <div class="flex justify-center">
                                    <button onclick="hideModal(); showSection('transport-manager');" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.primary};">
                                        סגור
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'route-view') {
                const townMap = modalState.townMap || {};
                const towns = Object.keys(townMap).sort();
                
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: ${COLORS.modalBackdrop};" onclick="event.target === event.currentTarget && hideModal()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                            <div class="p-4 lg:p-6">
                                <div class="text-center mb-4 lg:mb-6 pb-4 border-b-2" style="border-color: ${COLORS.primary};">
                                    <i class="fas fa-route text-3xl lg:text-4xl mb-2 lg:mb-3" style="color: ${COLORS.primary};"></i>
                                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-1">${modalState.routeName}</h3>
                                    <p class="text-sm lg:text-base text-gray-600">מסלול מלא</p>
                                </div>
                                
                                <div class="space-y-4 lg:space-y-6">
                                    ${towns.length === 0 ? `
                                        <div class="text-center py-8 text-gray-500">
                                            <i class="fas fa-info-circle text-2xl mb-2"></i>
                                            <p>אין מיקומים במסלול זה</p>
                                        </div>
                                    ` : towns.map(town => `
                                        <div class="bg-white rounded-lg border-2 shadow-sm overflow-hidden" style="border-color: ${COLORS.primary};">
                                            <div class="px-4 lg:px-6 py-3 lg:py-4 text-white font-bold text-base lg:text-lg flex items-center gap-2" style="background-color: ${COLORS.primary};">
                                                <i class="fas fa-map-marker-alt"></i>
                                                ${town}
                                            </div>
                                            <div class="p-4 lg:p-6">
                                                <ul class="space-y-2 lg:space-y-3 text-right">
                                                    ${townMap[town].map(address => `
                                                        <li class="flex items-center gap-2 lg:gap-3 p-2 lg:p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                            <i class="fas fa-circle text-xs flex-shrink-0" style="color: ${COLORS.accent};"></i>
                                                            <span class="text-sm lg:text-base text-gray-800">${address}</span>
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="flex justify-center mt-6 pt-4 border-t-2 border-gray-200">
                                    <button onclick="hideModal()" class="px-6 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.primary};">
                                        <i class="fas fa-times ml-2"></i>
                                        סגור
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'info') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: ${COLORS.modalBackdrop};" onclick="event.target === event.currentTarget && hideModal()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-4 lg:mb-6">
                                    <i class="fas fa-info-circle text-4xl lg:text-5xl mb-3 lg:mb-4" style="color: ${COLORS.primary};"></i>
                                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-2 lg:mb-3">מידע</h3>
                                </div>
                                <div class="text-right text-gray-700 text-sm lg:text-base leading-relaxed space-y-3">
                                    ${modalState.message.split('\n').map(line => line.trim() ? `<p class="mb-2">${line}</p>` : '<br>').join('')}
                                </div>
                                <div class="flex justify-center mt-6 pt-4 border-t-2 border-gray-200">
                                    <button onclick="hideModal()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.primary};">
                                        סגור
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (modalState.type === 'error') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: ${COLORS.modalBackdrop};" onclick="event.target === event.currentTarget && hideModal()">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-4 lg:mb-6">
                                    <i class="fas fa-exclamation-circle text-4xl lg:text-5xl mb-3 lg:mb-4" style="color: ${COLORS.error};"></i>
                                    <h3 class="text-lg lg:text-xl font-bold text-gray-800 mb-2 lg:mb-3">שגיאה</h3>
                                    <p class="text-gray-600 text-base lg:text-lg">${modalState.message}</p>
                                </div>
                                <div class="flex justify-center">
                                    <button onclick="hideModal()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg text-sm lg:text-base font-bold transition shadow-md hover:opacity-90 text-white" style="background-color: ${COLORS.error};">
                                        סגור
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        function RouteModalComponent() {
            if (!routeModalState.show) return '';

            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4" style="background-color: ${COLORS.modalBackdrop};">
                    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-4 lg:p-6">
                            <div class="flex items-center justify-between mb-4 lg:mb-6">
                                <h3 class="text-lg lg:text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fas fa-route" style="color: ${COLORS.primary};"></i>
                                    ${routeModalState.isEditing ? 'ערוך מסלול' : 'הוסף מסלול חדש'}
                                </h3>
                                <button onclick="if(routeModalState.map) { routeModalState.map.remove(); } routeModalState = { show: false, routeName: '', selectedLocations: [], departureTime: '07:00', map: null, markers: [], isEditing: false }; render();" class="text-gray-500 hover:text-gray-700 text-xl lg:text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="space-y-4 lg:space-y-6">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2 text-sm lg:text-base">שם מסלול</label>
                                    <input type="text" id="route-name-input" value="${routeModalState.routeName}" oninput="routeModalState.routeName = this.value" placeholder="לדוגמה: מסלול א" class="w-full border-2 rounded-lg p-2 lg:p-3 outline-none transition bg-white text-sm lg:text-base" style="border-color: ${COLORS.primary}; focus:border-color: ${COLORS.primary}dd;" ${routeModalState.isEditing ? 'readonly' : ''}>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-medium mb-2 text-sm lg:text-base">זמן יציאה</label>
                                    <input type="time" id="route-departure-time" value="${routeModalState.departureTime || '07:00'}" class="w-full border-2 rounded-lg p-2 lg:p-3 outline-none transition bg-white text-sm lg:text-base" style="border-color: ${COLORS.primary}; focus:border-color: ${COLORS.primary}dd;">
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-medium mb-2 text-sm lg:text-base">
                                        <i class="fas fa-map ml-2" style="color: ${COLORS.primary};"></i>
                                        מפה אינטראקטיבית
                                    </label>
                                    <p class="text-xs lg:text-sm text-gray-600 mb-2">לחץ על המפה כדי להוסיף מיקום</p>
                                    <div id="route-map-container" class="w-full h-64 lg:h-96 rounded-lg border-2 border-gray-300 mb-4" style="border-color: ${COLORS.primary};"></div>
                                </div>

                                <div class="bg-gray-50 rounded-lg p-4 lg:p-5 border-2" style="border-color: ${COLORS.primary};">
                                    <label class="block text-gray-700 font-medium mb-3 text-sm lg:text-base">
                                        <i class="fas fa-map-marker-alt ml-2" style="color: ${COLORS.primary};"></i>
                                        הוסף מיקום ידנית
                                    </label>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-gray-600 text-xs lg:text-sm mb-1">עיר</label>
                                            <input type="text" id="route-city-input" placeholder="לדוגמה: מודיעין" class="w-full border-2 rounded-lg p-2 lg:p-3 outline-none transition bg-white text-sm lg:text-base" style="border-color: ${COLORS.primary}; focus:border-color: ${COLORS.primary}dd;" onkeypress="if(event.key === 'Enter') { event.preventDefault(); addLocationToRoute(); }">
                                        </div>
                                        <div>
                                            <label class="block text-gray-600 text-xs lg:text-sm mb-1">כתובת</label>
                                            <input type="text" id="route-address-input" placeholder="לדוגמה: עמק האלה 9" class="w-full border-2 rounded-lg p-2 lg:p-3 outline-none transition bg-white text-sm lg:text-base" style="border-color: ${COLORS.primary}; focus:border-color: ${COLORS.primary}dd;" onkeypress="if(event.key === 'Enter') { event.preventDefault(); addLocationToRoute(); }">
                                        </div>
                                    </div>
                                    <button onclick="addLocationToRoute()" class="w-full px-4 py-2 lg:py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 text-sm lg:text-base" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                        <i class="fas fa-plus ml-2"></i>
                                        הוסף מיקום
                                    </button>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-medium mb-2 text-sm lg:text-base" data-locations-count>
                                        מיקומים נבחרים (${routeModalState.selectedLocations.length})
                                    </label>
                                    <div id="route-locations-list" class="max-h-64 overflow-y-auto border-2 border-gray-300 rounded-lg p-2 lg:p-3 space-y-2" style="border-color: ${COLORS.primary};">
                                        ${routeModalState.selectedLocations.length === 0 ? `
                                            <p class="text-gray-500 text-center text-sm lg:text-base py-6">
                                                <i class="fas fa-info-circle ml-2"></i>
                                                אין מיקומים נבחרים. הוסף מיקומים באמצעות הטופס למעלה.
                                            </p>
                                        ` : routeModalState.selectedLocations.map((loc, index) => `
                                            <div class="flex items-center justify-between p-3 lg:p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                <div class="flex-1 text-right">
                                                    <p class="font-bold text-sm lg:text-base text-gray-800 flex items-center gap-2">
                                                        <i class="fas fa-map-marker-alt text-xs" style="color: ${COLORS.primary};"></i>
                                                        ${loc.city}
                                                    </p>
                                                    <p class="text-xs lg:text-sm text-gray-600 mt-1">${loc.address}</p>
                                                </div>
                                                <button onclick="removeLocationFromRoute(${index})" class="ml-3 p-2 rounded transition flex-shrink-0" style="color: ${COLORS.error}; hover:color: ${COLORS.error}dd; hover:background-color: ${COLORS.error}33;">
                                                    <i class="fas fa-times text-sm lg:text-base"></i>
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="flex gap-3 justify-center pt-4 border-t-2 border-gray-200">
                                    <button onclick="if(routeModalState.map) { routeModalState.map.remove(); } routeModalState = { show: false, routeName: '', selectedLocations: [], departureTime: '07:00', map: null, markers: [], isEditing: false }; render();" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 text-sm lg:text-base" style="background-color: ${COLORS.bgLight}; color: ${COLORS.textDark};">
                                        ביטול
                                    </button>
                                    <button onclick="saveNewRoute()" class="px-4 lg:px-8 py-2 lg:py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 text-white text-sm lg:text-base" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                        <i class="fas fa-check ml-2"></i>
                                        בחירה
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // רינדור המערכת
        function render() {
            const menuItems = [
                { id: 'dashboard', label: 'דשבורד', icon: 'fa-home' },

                { id: 'employee-portal', label: 'הבקשות שלי', icon: 'fa-user' },
                { id: 'employees', label: 'רשימת עובדים', icon: 'fa-users' },

                { id: 'employee-management', label: 'ניהול עובדים', icon: 'fa-user-cog' },
                { id: 'employee-arrangement', label: 'סידור עובדים', icon: 'fa-users-cog' },
                { id: 'transport-manager', label: 'אחראי הסעות', icon: 'fa-paper-plane' },
                { id: 'driver-view', label: 'תצוגת נהג', icon: 'fa-car' },
                { id: 'routes', label: 'ניהול מסלולים', icon: 'fa-route' },
                { id: 'reports', label: 'דוחות', icon: 'fa-chart-bar' },

                { id: 'alerts', label: 'התראות ועדכונים', icon: 'fa-bell' },
                { id: 'login', label: 'התחברות', icon: 'fa-sign-in-alt' }
            ];

            let content = '';
            switch(currentSection) {
                case 'dashboard': content = DashboardView(); break;
                case 'driver-view': content = DriverView(); break;
                case 'transport-manager': content = TransportManagerView(); break;

                case 'employee-arrangement': content = EmployeeArrangementView(); break;
                case 'employees': content = EmployeesView(); break;

                case 'employee-management': content = EmployeeManagementView(); break;
                case 'routes': content = RoutesView(); break;
                case 'employee-portal': content = EmployeePortalView(); break;

                case 'alerts': content = AlertsView(); break;
                case 'reports': content = ReportsView(); break;
                case 'login': content = LoginView(); break;
            }

            const currentMenuItem = menuItems.find(item => item.id === currentSection);

            const downloadRibbon = document.getElementById('downloadAppRibbon');
            const ua = navigator.userAgent || '';
            const isCapacitor = !!(window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.isNativePlatform());
            const isWebViewAndroid = /Android/.test(ua) && /wv/.test(ua);
            const isWebViewIOS = /iPhone|iPad|iPod/.test(ua) && !/Safari/.test(ua);
            const isFileProtocol = window.location && window.location.protocol === 'file:';
            const isCapacitorProtocol = window.location && window.location.protocol === 'capacitor:';
            const isStandaloneDisplay = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
            const isFullscreenDisplay = window.matchMedia && window.matchMedia('(display-mode: fullscreen)').matches;
            const isMinimalUiDisplay = window.matchMedia && window.matchMedia('(display-mode: minimal-ui)').matches;
            const isStandaloneIOS = window.navigator && window.navigator.standalone === true;
            const urlParams = new URLSearchParams(window.location ? window.location.search : '');
            const hideDownloadParam = urlParams.get('hideDownload') === '1';
            const isNativeApp = isCapacitor || isWebViewAndroid || isWebViewIOS || isFileProtocol || isCapacitorProtocol || isStandaloneDisplay || isFullscreenDisplay || isMinimalUiDisplay || isStandaloneIOS || hideDownloadParam;
            if (downloadRibbon) {
                downloadRibbon.style.display = currentSection === 'login' && !isNativeApp ? 'flex' : 'none';
            }

            if (currentSection === 'login') {
                document.documentElement.classList.add('login-screen');
                document.body.classList.add('login-screen');
            } else {
                document.documentElement.classList.remove('login-screen');
                document.body.classList.remove('login-screen');
            }

            // If login screen, show only login view without sidebar/header
            if (currentSection === 'login') {

                document.getElementById('app').innerHTML = content + ModalComponent() + RegisterModalComponent() + ForgotPasswordModalComponent() + AlertsModalComponent() + AddEmployeeModalComponent();
            } else {
                document.getElementById('app').innerHTML = `

                    <!-- Mobile Sidebar Overlay -->
                    ${sidebarOpen ? `<div class="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden" onclick="toggleSidebar()"></div>` : ''}
                    
                    <!-- Sidebar -->

                    <div class="fixed top-0 right-0 h-full bg-white shadow-2xl transition-all duration-300 z-30 ${sidebarOpen ? 'w-64' : 'w-0'} overflow-hidden flex flex-col ${sidebarOpen ? '' : 'translate-x-full'}">
                        <nav class="p-2 lg:p-4 space-y-1 flex-1 overflow-y-auto">
                            ${menuItems.filter(item => item.id !== 'login').map(item => `
                                <button

                                    onclick="showSection('${item.id}'); if(window.innerWidth < 1024) { sidebarOpen = false; render(); }"
                                    class="w-full flex items-center gap-2 lg:gap-3 px-3 lg:px-4 py-2 lg:py-3 rounded-lg transition font-bold text-sm lg:text-base text-black hover:bg-gray-50"
                                    style="${currentSection === item.id ? `background-color: rgba(80, 116, 128, 0.3);` : ''}"
                                >
                                    <i class="fas ${item.icon} text-lg"></i>
                                    <span>${item.label}</span>
                                </button>
                            `).join('')}
                        </nav>

                        <div class="p-4 lg:p-6 text-white flex items-center gap-2 lg:gap-3" style="background-color: ${COLORS.primary};">
                            <i class="fas fa-building text-2xl lg:text-3xl"></i>
                            <div>

                                <h1 class="text-base lg:text-xl font-bold">מערכת הסעות</h1>
                                <p class="text-xs opacity-90">מנהל מערכת</p>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->

                    <div class="transition-all duration-300" style="margin-right: ${sidebarOpen ? '16rem' : '0'};">
                        <div class="sticky top-0 z-20 shadow-sm" style="background-color: ${COLORS.primary};">
                            <div class="px-3 lg:px-6 py-3 lg:py-4 flex justify-between items-center">
                                <div class="flex items-center gap-2 lg:gap-4">
                                    <button onclick="toggleSidebar()" class="p-2 hover:opacity-80 rounded-lg transition" style="color: ${COLORS.accent};">
                                        <i class="fas ${sidebarOpen ? 'fa-times' : 'fa-bars'} text-lg lg:text-xl"></i>
                                    </button>

                                    <h1 class="text-base lg:text-lg font-bold" style="color: ${COLORS.accent};">
                                        ${currentMenuItem ? currentMenuItem.label : ''}
                                    </h1>
                                </div>

                                <button onclick="showSection('login')" class="px-3 lg:px-4 py-2 rounded-lg font-bold text-sm lg:text-base transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                    <i class="fas fa-sign-out-alt ml-1 lg:ml-2"></i>
                                    <span class="hidden sm:inline">התנתקות</span>
                                </button>
                            </div>
                        </div>


                        <div class="p-3 lg:p-6">
                            ${content}
                        </div>
                    </div>

                    ${ModalComponent()}
                    ${RouteModalComponent()}
                    ${RegisterModalComponent()}
                    ${ForgotPasswordModalComponent()}
                    ${AlertsModalComponent()}
                    ${AddEmployeeModalComponent()}
                `;
            }
        }


        // Registration Modal Functions
        function openRegisterModal() {
            registerModalState.show = true;
            render();
        }

        function closeRegisterModal() {
            registerModalState.show = false;
            render();
        }

        async function handleRegister() {
            const name = document.getElementById('registerName')?.value.trim();
            const phone = document.getElementById('registerPhone')?.value.trim();
            const email = document.getElementById('registerEmail')?.value.trim();
            const address = document.getElementById('registerAddress')?.value.trim();
            const city = document.getElementById('registerCity')?.value.trim();
            const route = document.getElementById('registerRoute')?.value;
            const time = document.getElementById('registerTime')?.value || '07:00';
            const department = document.getElementById('registerDepartment')?.value.trim() || '';
            const username = document.getElementById('registerUsername')?.value.trim();
            const password = document.getElementById('registerPassword')?.value.trim();
            const confirmPassword = document.getElementById('registerConfirmPassword')?.value.trim();

            if (!name || !phone || !address || !city || !route || !username || !password || !confirmPassword) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }

            // Validate email format if provided
            if (email && !email.includes('@')) {
                alert('אנא הזן כתובת אימייל תקינה');
                return;
            }

            if (password !== confirmPassword) {
                alert('הסיסמאות אינן תואמות');
                return;
            }

            try {
                // Register via backend API
                const response = await fetch(`${API_CONFIG.baseUrl}/employees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        name,
                        phone,
                        email: email || null,
                        address,
                        city,
                        route,
                        time,
                        department,
                        active: true
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Add to local array too (so UI updates immediately)
                    employees.push({
                        id: data.id,
                        name, phone, email: email || '', address, city,
                        route, time, department, username, active: true
                    });

                    alert('ההרשמה בוצעה בהצלחה! כעת תוכל להתחבר');
                    closeRegisterModal();
                } else {
                    alert(data.error === 'Username or worker code already exists' ?
                        'שם משתמש זה כבר קיים' : 'שגיאה בהרשמה. נסה שוב.');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('שגיאה בחיבור לשרת. ודא שהשרת פועל.');
            }
        }

        // Forgot Password Modal Functions
        function openForgotPasswordModal() {
            forgotPasswordModalState.show = true;
            forgotPasswordModalState.step = 'verify';
            forgotPasswordModalState.verifiedEmployee = null;
            render();
        }

        function closeForgotPasswordModal() {
            forgotPasswordModalState.show = false;
            forgotPasswordModalState.step = 'verify';
            forgotPasswordModalState.verifiedEmployee = null;
            render();
        }

        function verifyForgotPassword() {
            const memberCode = document.getElementById('forgotMemberCode')?.value.trim();
            const emailInput = document.getElementById('forgotEmailCode')?.value.trim();

            if (!memberCode && !emailInput) {
                alert('אנא הזן שם משתמש או כתובת אימייל');
                return;
            }

            let employee = null;

            // Try to find by member code (username or worker code)
            if (memberCode) {
                const usernameLower = memberCode.toLowerCase().trim();
                employee = employees.find(e =>
                    (e.workerCode && e.workerCode === memberCode) ||
                    (e.username && e.username.toLowerCase().trim() === usernameLower) ||
                    e.name.toLowerCase().includes(usernameLower) ||
                    e.name.toLowerCase() === usernameLower
                );
            }

            // Try to find by email
            if (!employee && emailInput) {
                if (emailInput.includes('@')) {
                    const emailToFind = emailInput.toLowerCase().trim();
                    employee = employees.find(e => {
                        if (e.email) {
                            return e.email.toLowerCase().trim() === emailToFind;
                        }
                        return false;
                    });
                } else {
                    // Maybe it's a phone number
                    employee = employees.find(e => e.phone && (e.phone === emailInput || e.phone.replace(/-/g, '') === emailInput.replace(/-/g, '')));
                }
            }

            if (employee) {
                // If email was used, send reset email
                if (emailInput && !memberCode) {
                    if (employee.email && employee.email.trim() && EMAIL_CONFIG.enabled) {
                        // Validate email format
                        if (!employee.email.includes('@')) {
                            alert('כתובת האימייל לא תקינה.');
                            return;
                        }

                        const emailToSend = employee.email.trim();
                        const verificationToken = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

                        // Create a token that includes email hash for verification across domains
                        const emailForHash = employee.email.toLowerCase().trim();
                        const emailHash = btoa(emailForHash).substring(0, 10);
                        const tokenWithEmail = `${verificationToken}_${emailHash}`;

                        // Save token to localStorage
                        const resetTokens = JSON.parse(localStorage.getItem('passwordResetTokens') || '{}');
                        resetTokens[tokenWithEmail] = {
                            employeeId: employee.id,
                            email: employee.email.toLowerCase(),
                            timestamp: Date.now(),
                            expiresIn: 3600000
                        };
                        localStorage.setItem('passwordResetTokens', JSON.stringify(resetTokens));

                        sendEmail(emailToSend, employee.name, tokenWithEmail, employee).then(() => {
                            alert(`הודעת אימייל נשלחה ל-${employee.email}. אנא בדוק את תיבת הדואר שלך.`);
                            forgotPasswordModalState.show = false;
                            render();
                        }).catch((error) => {
                            console.error('Email sending failed:', error);
                            alert(`שגיאה בשליחת אימייל: ${error.message || 'Unknown error'}. אנא נסה שוב או השתמש בקוד חבר.`);
                        });
                    } else if (!employee.email || !employee.email.trim()) {
                        alert(`העובד ${employee.name} נמצא, אבל אין לו כתובת אימייל במערכת. אנא השתמש בקוד חבר או הוסף אימייל לעובד.`);
                    } else if (!EMAIL_CONFIG.enabled) {
                        alert('שירות האימייל לא מופעל. אנא השתמש בקוד חבר.');
                    }
                } else {
                    // Member code was used, go directly to reset
                    forgotPasswordModalState.verifiedEmployee = employee;
                    forgotPasswordModalState.step = 'reset';
                    render();
                }
            } else {
                alert('לא נמצא עובד. אנא בדוק את הפרטים ונסה שוב.');
            }
        }

        // Function to send email via EmailJS (FREE - 200 emails/month)
        async function sendEmail(emailAddress, userName, verificationToken, employee = null) {
            if (!EMAIL_CONFIG.enabled || !EMAIL_CONFIG.serviceId || !EMAIL_CONFIG.templateId) {
                throw new Error('Email service not configured');
            }

            // Validate email address
            if (!emailAddress || !emailAddress.trim()) {
                throw new Error('Email address is empty');
            }

            // Initialize EmailJS
            if (typeof emailjs === 'undefined') {
                throw new Error('EmailJS library not loaded');
            }

            emailjs.init(EMAIL_CONFIG.publicKey);

            // Create verification link using the configured baseUrl - pointing to index.html
            const baseUrl = EMAIL_CONFIG.baseUrl || window.location.origin;
            const verificationLink = `${baseUrl}/?reset=${verificationToken}`;

            // Prepare template parameters - EmailJS uses different variable names
            // IMPORTANT: In EmailJS template, set "To Email" field to: {{to_email}}
            // The "To Email" field in the template MUST use {{to_email}} variable
            const emailToSend = emailAddress.trim();
            const templateParams = {
                to_email: emailToSend, // This MUST match the variable name in your EmailJS template's "To Email" field
                reply_to: emailToSend, // Optional: reply-to address
                to_name: userName || '',
                user_name: userName || '',
                from_name: 'מערכת הסעות', // Optional: sender name
                reset_link: verificationLink,
                message: `התקבלה פעולת שחזור חשבון לחשבונכם, לאישור איתחול לחץ כאן: ${verificationLink}`,
                // Add worker-specific information
                worker_id: employee?.id || '',
                worker_phone: employee?.phone || '',
                worker_route: employee?.route || '',
                worker_city: employee?.city || '',
                worker_address: employee?.address || '',
                worker_code: employee?.code || ''
            };

            console.log('Sending email with params:', {
                to_email: templateParams.to_email,
                emailAddress: emailToSend,
                serviceId: EMAIL_CONFIG.serviceId,
                templateId: EMAIL_CONFIG.templateId,
                allParams: templateParams
            });

            try {
                const response = await emailjs.send(
                    EMAIL_CONFIG.serviceId,
                    EMAIL_CONFIG.templateId,
                    templateParams
                );

                return response;
            } catch (error) {
                console.error('Error sending email:', error);
                console.error('EmailJS error details:', {
                    status: error.status,
                    text: error.text,
                    message: error.message
                });
                throw error;
            }
        }

        // Delete user function

        async function resetPassword() {
            const newPassword = document.getElementById('newPassword')?.value.trim();
            const confirmNewPassword = document.getElementById('confirmNewPassword')?.value.trim();

            if (!newPassword || !confirmNewPassword) {
                alert('אנא מלא את כל השדות');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                alert('הסיסמאות אינן תואמות');
                return;
            }

            if (forgotPasswordModalState.verifiedEmployee) {
                try {
                    // Call backend to change password
                    const response = await fetch(`${API_CONFIG.baseUrl}/auth/change-password`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            employeeId: forgotPasswordModalState.verifiedEmployee.id,
                            newPassword: newPassword
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        alert('הסיסמה עודכנה בהצלחה במסד הנתונים! כעת תוכל להתחבר עם הסיסמה החדשה');
                        closeForgotPasswordModal();
                    } else {
                        alert('שגיאה בעדכון הסיסמה. נסה שוב.');
                    }
                } catch (error) {
                    console.error('Password reset error:', error);
                    alert('שגיאה בחיבור לשרת. ודא שהשרת פועל.');
                }
            }
        }

        function RegisterModalComponent() {
            if (!registerModalState.show) return '';

            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style="background-color: ${COLORS.modalBackdrop};">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-6 lg:p-8">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl lg:text-2xl font-bold text-gray-800">רישום למערכת</h3>
                                <button onclick="closeRegisterModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <form onsubmit="event.preventDefault(); handleRegister();" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                        <label class="block text-gray-700 font-medium mb-2">שם מלא *</label>
                                        <input type="text" id="registerName" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                            </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">טלפון *</label>
                                        <input type="tel" id="registerPhone" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="050-123-4567" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">אימייל</label>
                                        <input type="email" id="registerEmail" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="user@example.com">
                                        <p class="text-xs text-gray-500 mt-1">מומלץ למטרת שחזור סיסמה (בחינם)</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">כתובת *</label>
                                        <input type="text" id="registerAddress" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>

                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">עיר *</label>
                                        <input type="text" id="registerCity" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">מסלול *</label>
                                        <select id="registerRoute" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                            <option value="מסלול א">מסלול א</option>
                                            <option value="מסלול ב">מסלול ב</option>
                                            <option value="מסלול ג">מסלול ג</option>
                                            <option value="מסלול ד">מסלול ד</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">שעת איסוף</label>
                                        <input type="time" id="registerTime" value="07:00" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">חברה/מחלקה</label>
                                        <input type="text" id="registerDepartment" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">שם משתמש *</label>
                                        <input type="text" id="registerUsername" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">סיסמה *</label>
                                        <input type="password" id="registerPassword" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">אישור סיסמה *</label>
                                        <input type="password" id="registerConfirmPassword" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <button type="button" onclick="closeRegisterModal()" class="flex-1 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 bg-gray-200 text-gray-700">
                                        ביטול
                                    </button>
                                    <button type="submit" class="flex-1 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                        הרשמה
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function ForgotPasswordModalComponent() {
            if (!forgotPasswordModalState.show) return '';

            if (forgotPasswordModalState.step === 'verify') {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style="background-color: ${COLORS.modalBackdrop};">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-6">
                                    <i class="fas fa-key text-5xl mb-4" style="color: ${COLORS.primary};"></i>
                                    <h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">שחזור סיסמה</h3>
                                    <p class="text-gray-600 text-sm">הזן קוד חבר, אימייל או מספר טלפון לאימות</p>
                                </div>
                                
                                <form onsubmit="event.preventDefault(); verifyForgotPassword();" class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">קוד חבר (מספר עובד או שם משתמש)</label>
                                        <input type="text" id="forgotMemberCode" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="לדוגמה: 1 או בן אליהו">
                                    </div>
                                    
                                    <div class="text-center text-gray-500 py-2">או</div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">כתובת אימייל</label>
                                        <input type="text" id="forgotEmailCode" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="לדוגמה: user@email.com">
                                        <p class="text-xs text-gray-500 mt-1">קישור לאיפוס סיסמה יישלח לאימייל שלך</p>
                                    </div>
                                    
                                    <div class="flex gap-3 pt-4">
                                        <button type="button" onclick="closeForgotPasswordModal()" class="flex-1 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 bg-gray-200 text-gray-700">
                                            ביטול
                                        </button>
                                        <button type="submit" class="flex-1 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                            המשך
                                </button>
                            </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style="background-color: ${COLORS.modalBackdrop};">
                        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                            <div class="p-6 lg:p-8">
                                <div class="text-center mb-6">
                                    <i class="fas fa-lock text-5xl mb-4" style="color: ${COLORS.accent};"></i>
                                    <h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">הגדר סיסמה חדשה</h3>
                                    <p class="text-gray-600 text-sm">עבור: ${forgotPasswordModalState.verifiedEmployee?.name || ''}</p>
                        </div>

                                <form onsubmit="event.preventDefault(); resetPassword();" class="space-y-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">סיסמה חדשה *</label>
                                        <input type="password" id="newPassword" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">אישור סיסמה *</label>
                                        <input type="password" id="confirmNewPassword" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                    
                                    <div class="flex gap-3 pt-4">
                                        <button type="button" onclick="closeForgotPasswordModal()" class="flex-1 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 bg-gray-200 text-gray-700">
                                            ביטול
                                        </button>
                                        <button type="submit" class="flex-1 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                            שמור סיסמה
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function AlertsView() {
            const alerts = getAlerts();
            
            return `
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl lg:text-2xl font-bold text-gray-800 flex items-center gap-2 lg:gap-3">
                            <i class="fas fa-bell text-lg lg:text-xl" style="color: ${COLORS.primary};"></i>
                            התראות ועדכונים
                        </h2>
                        <button onclick="openAlertsModal()" class="px-4 lg:px-6 py-2 lg:py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 text-sm lg:text-base" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                            <i class="fas fa-plus ml-2"></i>
                            התראה חדשה
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold mb-4 text-gray-800">כל ההתראות</h3>
                        <div class="space-y-3">
                            ${alerts.length === 0 ? `
                                <div class="p-8 text-center text-gray-500">
                                    <i class="fas fa-bell-slash text-4xl mb-4 opacity-50"></i>
                                    <p>אין התראות עדיין</p>
                                    <p class="text-sm mt-2">לחץ על "התראה חדשה" כדי להוסיף התראה</p>
                                </div>
                            ` : alerts.map(alert => {
                                const alertDate = new Date(alert.date);
                                const now = new Date();
                                const daysDiff = Math.floor((now - alertDate) / (1000 * 60 * 60 * 24));
                                const hoursDiff = Math.floor((now - alertDate) / (1000 * 60 * 60));
                                let timeText = '';
                                if (daysDiff === 0) {
                                    timeText = hoursDiff < 1 ? 'לפני פחות משעה' : hoursDiff === 1 ? 'לפני שעה' : `לפני ${hoursDiff} שעות`;
                                } else if (daysDiff === 1) {
                                    timeText = 'אתמול';
                                } else {
                                    timeText = `לפני ${daysDiff} ימים`;
                                }
                                
                                return `
                                    <div class="p-4 rounded-lg border-2 flex items-start justify-between gap-3" style="background-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.05); border-color: rgba(${parseInt(COLORS.primary.slice(1, 3), 16)}, ${parseInt(COLORS.primary.slice(3, 5), 16)}, ${parseInt(COLORS.primary.slice(5, 7), 16)}, 0.2);">
                                        <div class="flex-1">
                                            <p class="font-bold text-gray-800 mb-1">${alert.text}</p>
                                            <p class="text-sm text-gray-500">${timeText} • ${alertDate.toLocaleDateString('he-IL')} ${alertDate.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}</p>
                                        </div>
                                        <button onclick="deleteAlert(${alert.id})" class="p-2 rounded transition flex-shrink-0 hover:opacity-80" style="color: ${COLORS.error}; background-color: ${COLORS.error}22;" title="מחק התראה">
                                            <i class="fas fa-trash text-sm"></i>
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function openAlertsModal() {
            alertsModalState.show = true;
            render();
        }

        function closeAlertsModal() {
            alertsModalState.show = false;
            render();
        }

        function publishAlert() {
            const alertText = document.getElementById('alertBody')?.value.trim();
            
            if (!alertText) {
                alert('אנא הזן גוף התראה');
                return;
            }
            
            addAlert(alertText);
            document.getElementById('alertBody').value = '';
            closeAlertsModal();
            render();
        }

        function AlertsModalComponent() {
            if (!alertsModalState.show) return '';

            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style="background-color: ${COLORS.modalBackdrop};">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                        <div class="p-6 lg:p-8">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl lg:text-2xl font-bold text-gray-800">התראה חדשה</h3>
                                <button onclick="closeAlertsModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">גוף ההתראה</label>
                                    <textarea id="alertBody" rows="4" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="הזן את תוכן ההתראה כאן..."></textarea>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <button type="button" onclick="closeAlertsModal()" class="flex-1 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90 bg-gray-200 text-gray-700">
                                        ביטול
                                    </button>
                                    <button onclick="publishAlert()" class="flex-1 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                        פרסום
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function AddEmployeeModalComponent() {
            if (!addEmployeeModalState.show) return '';

            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" style="background-color: ${COLORS.modalBackdrop};">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="p-8">
                            <div class="text-center mb-6">
                                <i class="fas fa-user-plus text-5xl mb-4" style="color: ${COLORS.accent};"></i>
                                <h3 class="text-xl font-bold text-gray-800 mb-3">הוספת עובד חדש</h3>
                            </div>
                            
                            <form onsubmit="event.preventDefault(); saveNewEmployee();" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">שם *</label>
                                        <input type="text" id="newEmployeeName" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">חברה/מחלקה</label>
                                        <input type="text" id="newEmployeeDepartment" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">כתובת *</label>
                                        <input type="text" id="newEmployeeAddress" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">עיר *</label>
                                        <input type="text" id="newEmployeeCity" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" value="מודיעין" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">טלפון</label>
                                        <input type="tel" id="newEmployeePhone" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">אימייל</label>
                                        <input type="email" id="newEmployeeEmail" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="user@example.com">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">מסלול</label>
                                        <select id="newEmployeeRoute" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                            <option value="מסלול א">מסלול א</option>
                                            <option value="מסלול ב">מסלול ב</option>
                                            <option value="מסלול ג">מסלול ג</option>
                                            <option value="מסלול ד">מסלול ד</option>
                                            <option value="מסלול ה">מסלול ה</option>
                                            <option value="מסלול ו">מסלול ו</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">שעת איסוף</label>
                                        <input type="time" id="newEmployeeTime" value="07:00" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">קוד משתמש *</label>
                                        <input type="text" id="newEmployeeUsername" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="קוד משתמש ייחודי" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 font-medium mb-2">סיסמה *</label>
                                        <input type="password" id="newEmployeePassword" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none transition bg-white" style="border-color: #d1d5db; focus:border-color: ${COLORS.primary};" placeholder="הזן סיסמה" required>
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 justify-center mt-6">
                                    <button type="button" onclick="addEmployeeModalState.show = false; render();" class="px-8 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.bgLight}; color: ${COLORS.textDark};">
                                        ביטול
                                    </button>
                                    <button type="submit" class="px-8 py-3 rounded-lg font-bold transition shadow-md hover:opacity-90" style="background-color: ${COLORS.accent}; color: ${COLORS.primary};">
                                        שמור עובד
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        // PWA Installation Handling
        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show custom install button if needed
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Download APK Handler
        function handleDownloadAPK(event) {
            // Prevent any default behavior
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Check if APK exists first
            const apkUrl = '/transport-system.apk';
            
            // Try to fetch the APK to see if it exists
            fetch(apkUrl, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        // APK exists - download it directly
                        const link = document.createElement('a');
                        link.href = apkUrl;
                        link.download = 'transport-system.apk';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } else {
                        // APK doesn't exist - show instructions
                        showPWABuilderInstructions();
                    }
                })
                .catch(() => {
                    // APK doesn't exist or error - show instructions
                    showPWABuilderInstructions();
                });
        }
        
        function showPWABuilderInstructions() {
            const siteUrl = EMAIL_CONFIG.baseUrl || 'https://razgabay123.github.io';
            const instructions = `
                <div style="text-align: right; direction: rtl; line-height: 1.8;">
                    <h3 style="color: ${COLORS.primary}; margin-bottom: 20px; font-size: 20px;">
                        <i class="fas fa-mobile-alt ml-2"></i>
                        הוראות בניית APK:
                    </h3>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin-bottom: 10px; font-weight: bold; color: ${COLORS.primary};">
                            שלב 1: פתח את PWABuilder
                        </p>
                        <p style="margin-bottom: 15px;">
                            לחץ על הכפתור למטה או היכנס ל: 
                            <a href="https://www.pwabuilder.com/?url=${encodeURIComponent(siteUrl)}" target="_blank" style="color: ${COLORS.primary}; text-decoration: underline;">PWABuilder.com</a>
                        </p>
                        
                        <p style="margin-bottom: 10px; font-weight: bold; color: ${COLORS.primary};">
                            שלב 2: בנה את ה-APK
                        </p>
                        <ol style="list-style: decimal; padding-right: 25px; margin-bottom: 15px;">
                            <li>לחץ על הכפתור <strong style="color: ${COLORS.primary}; font-size: 16px;">"Package for Stores"</strong></li>
                            <li>בחר <strong>"Android"</strong> מהרשימה</li>
                            <li>לחץ על <strong>"Generate Package"</strong> או <strong>"Download"</strong></li>
                            <li>המתן לסיום הבנייה (1-2 דקות)</li>
                            <li>הורד את קובץ ה-APK</li>
                        </ol>
                        <p style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 14px; border-right: 4px solid ${COLORS.primary};">
                            <strong>📱 הערה:</strong> הכפתור <strong>"Download Test Package"</strong> הוא לבדיקות בלבד. 
                            <br>לבניית APK מלא, השתמש ב-<strong>"Package for Stores"</strong>
                        </p>
                        
                        <p style="margin-bottom: 10px; font-weight: bold; color: ${COLORS.primary};">
                            שלב 3: חלץ את ה-APK מה-ZIP
                        </p>
                        <ol style="list-style: decimal; padding-right: 25px; margin-bottom: 15px;">
                            <li>פתח את קובץ ה-ZIP שהורדת</li>
                            <li>חפש בתוך התיקייה את קובץ ה-<code style="background: white; padding: 2px 6px; border-radius: 4px;">.apk</code></li>
                            <li>הוצא את קובץ ה-APK מהתיקייה</li>
                            <li>שנה את שמו ל-<code style="background: white; padding: 2px 6px; border-radius: 4px;">transport-system.apk</code></li>
                        </ol>
                        
                        <p style="margin-bottom: 10px; font-weight: bold; color: ${COLORS.primary};">
                            שלב 4: העלה את הקובץ
                        </p>
                        <p>
                            העלה את קובץ ה-<code style="background: white; padding: 2px 6px; border-radius: 4px;">transport-system.apk</code> לתיקיית הפרויקט ב-GitHub (אותה תיקייה שבה נמצא transport-system.html).
                        </p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="https://www.pwabuilder.com/?url=${encodeURIComponent(siteUrl)}" target="_blank" 
                           style="display: inline-block; padding: 12px 24px; background: ${COLORS.accent}; color: ${COLORS.primary}; 
                                  text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px;">
                            <i class="fas fa-external-link-alt ml-2"></i>
                            פתח PWABuilder
                        </a>
                    </div>
                </div>
            `;
            showModal('info', instructions);
        }

        // הפעלה ראשונית - Load data then render
        async function initApp() {
            // Try to load from localStorage first (for offline support)
            loadFromLocalStorage();

            // Then load fresh data from JSON
            await loadWorkersData();

            // Save to localStorage for offline access
            saveEmployees();

            // Now render the app
            render();
        }

        // Start the app
        initApp();
    </script>
</body>

</html>
